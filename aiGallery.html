<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ç”»å»Š - Kayler</title>
    <link rel="icon" href="/favicon.png" type="image/png">
    
    <script src="layout.js?v=5.1"></script>

    <style>
        :root {
            --bg-body: #f2f4f7; --brand-brown: #8b5e3c; --brand-brown-hover: #6d4c41;
            --card-shadow: 0 4px 20px rgba(0,0,0,0.05);
            --layout-width: 94%; --layout-max-width: 1600px;
        }
        body {
            font-family: "PingFang SC", "Microsoft YaHei", sans-serif;
            background-color: var(--bg-body); margin: 0; padding: 20px;
            display: flex; flex-direction: column; align-items: center;
            min-height: 100vh; color: #333;
        }
        
        /* 1. æ ‡é¢˜åŒºåŸŸä¼˜åŒ– */
        header { text-align: center; margin-bottom: 20px; margin-top: 10px; }
        h1 { font-size: 28px; font-weight: 800; margin: 0; display: flex; align-items: center; justify-content: center; color: #2c2c2c; }
        
        /* 2. æœç´¢ä¸ç­›é€‰åŒº (v12.0 æ–°å¢) */
        .filter-area {
            width: 100%; max-width: 1000px; margin-bottom: 20px;
            display: flex; flex-direction: column; align-items: center; gap: 15px;
        }
        
        /* æœç´¢æ¡† */
        .search-wrapper {
            position: relative; width: 100%; max-width: 500px;
        }
        .search-input {
            width: 100%; padding: 10px 15px 10px 40px; border: 1px solid #ddd; border-radius: 50px;
            font-size: 14px; outline: none; transition: 0.2s; box-shadow: 0 2px 10px rgba(0,0,0,0.03);
        }
        .search-input:focus { border-color: var(--brand-brown); box-shadow: 0 4px 15px rgba(139, 94, 60, 0.15); }
        .search-icon { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: #999; }

        /* æ ‡ç­¾äº‘ */
        .tags-container {
            display: flex; flex-wrap: wrap; justify-content: center; gap: 8px;
        }
        .filter-tag {
            padding: 4px 12px; background: white; border: 1px solid #eee; border-radius: 20px;
            font-size: 12px; color: #666; cursor: pointer; transition: 0.2s; user-select: none;
        }
        .filter-tag:hover { border-color: var(--brand-brown); color: var(--brand-brown); transform: translateY(-2px); }
        .filter-tag.active { background: var(--brand-brown); color: white; border-color: var(--brand-brown); }

        /* 3. æ“ä½œæ  */
        .action-bar { display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; margin-bottom: 20px; }
        .btn-pill {
            padding: 6px 16px; border-radius: 50px; border: 1px solid #ddd;
            background: white; color: #666; cursor: pointer; font-size: 13px;
            display: flex; align-items: center; gap: 6px; transition: all 0.2s;
        }
        .btn-pill:hover { border-color: var(--brand-brown); color: var(--brand-brown); }
        .btn-upload { background: var(--brand-brown); color: white; border-color: var(--brand-brown); display: none; }
        .btn-upload:hover { background: var(--brand-brown-hover); color: white; }

        /* 4. ç€‘å¸ƒæµå¸ƒå±€ */
        .gallery-container { column-count: 5; column-gap: 20px; width: var(--layout-width); max-width: var(--layout-max-width); min-height: 600px; }
        .gallery-item {
            background: white; border-radius: 12px; margin-bottom: 20px; overflow: hidden; break-inside: avoid;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); transition: transform 0.3s, box-shadow 0.3s; 
            cursor: zoom-in; position: relative; opacity: 0; animation: fadeIn 0.5s forwards;
        }
        .gallery-item:hover { transform: translateY(-5px); box-shadow: 0 8px 25px rgba(0,0,0,0.1); }
        .gallery-item img { width: 100%; height: auto; display: block; background: #eee; min-height: 150px; }
        .item-info { padding: 12px 15px; border-top: 1px solid #f5f5f5; }
        .item-title { font-size: 13px; font-weight: bold; color: #333; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .item-meta { font-size: 11px; color: #bbb; display: flex; justify-content: space-between; }

        /* 5. åˆ†é¡µ */
        .pagination { display: flex; justify-content: center; align-items: center; gap: 8px; margin: 30px 0; }
        .page-btn { padding: 6px 12px; border: 1px solid #ddd; background: white; color: #555; border-radius: 6px; cursor: pointer; font-size: 13px; min-width: 32px; }
        .page-btn.active { background: var(--brand-brown); color: white; border-color: var(--brand-brown); }
        .page-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        #loadingState { width: 100%; text-align: center; color: #999; margin-top: 50px; display: flex; flex-direction: column; align-items: center; gap: 10px; }
        .spinner { width: 30px; height: 30px; border: 3px solid #eee; border-top: 3px solid var(--brand-brown); border-radius: 50%; animation: spin 1s linear infinite; }
        #upload-toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); color: white; padding: 12px 25px; border-radius: 30px; font-size: 14px; z-index: 9999; display: none; }

        /* æ¨¡æ€æ¡†é€šç”¨ */
        .modal { display: none; position: fixed; z-index: 2000; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); justify-content: center; align-items: center; flex-direction: column; backdrop-filter: blur(5px); }
        .modal.active { display: flex; }
        .close-modal { position: absolute; top: 30px; right: 30px; color: white; font-size: 40px; cursor: pointer; z-index: 2001; }
        
        /* å›¾ç‰‡é¢„è§ˆ */
        .modal.preview-mode img, .modal.preview-mode video { max-width: 90%; max-height: 80vh; border-radius: 4px; box-shadow: 0 0 30px rgba(0,0,0,0.5); }
        .modal-caption { color: #ccc; margin-top: 20px; font-size: 16px; }
        
        /* é…ç½®/ä¸Šä¼ å¼¹çª— */
        .modal-overlay-light { background: rgba(0,0,0,0.5); }
        .config-box { background: white; width: 400px; max-width: 90%; padding: 25px; border-radius: 12px; display: flex; flex-direction: column; gap: 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); }
        .config-title { font-size: 18px; font-weight: bold; margin: 0; }
        .config-row { display: flex; flex-direction: column; gap: 5px; }
        .config-label { font-size: 12px; font-weight: bold; color: #666; }
        .config-input { padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; outline: none; background: #fafafa; }
        .config-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 10px; }
        .btn-cancel { padding: 8px 16px; background: #eee; border: none; border-radius: 6px; cursor: pointer; }
        .btn-confirm { padding: 8px 20px; background: var(--brand-brown); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; }
        
        /* ä¸Šä¼ é…ç½®ä¸“ç”¨ */
        .config-check-label { display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 14px; background: #f9f9f9; padding: 10px; border-radius: 6px; }
        .config-hidden-area { display: none; flex-direction: column; gap: 15px; padding: 15px; background: #fdfdfd; border: 1px dashed #ddd; border-radius: 8px; }
        .btn-delete { position: absolute; top: 30px; left: 30px; background: rgba(255, 0, 0, 0.7); color: white; border: none; padding: 8px 16px; border-radius: 20px; cursor: pointer; display: none; z-index: 2001; }

        @media (max-width: 1600px) { .gallery-container { column-count: 4; } }
        @media (max-width: 1200px) { .gallery-container { column-count: 3; } }
        @media (max-width: 900px) { .gallery-container { column-count: 2; } }
        @media (max-width: 600px) { .gallery-container { column-count: 1; } }
    </style>
</head>
<body>
    
    <div id="upload-toast">â³ æ­£åœ¨ä¸Šä¼ ...</div>

    <header>
        <h1><img src="/logo.png" alt="Logo" style="height: 36px; vertical-align: middle; margin-right: 8px;">AI ç”»å»Š</h1>
    </header>

    <div class="filter-area">
        <div class="search-wrapper">
            <span class="search-icon">ğŸ”</span>
            <input type="text" class="search-input" id="searchInput" placeholder="æœç´¢å›¾ç‰‡åç§°..." oninput="handleSearch()">
        </div>
        <div class="tags-container" id="tagsContainer">
            </div>
    </div>

    <div class="action-bar">
        <button class="btn-pill" onclick="initGallery()"><span>ğŸ”„ åˆ·æ–°</span></button>
        
        <input type="file" id="imgUploadInput" accept="image/*,video/mp4" multiple style="display:none;" onchange="prepareUpload(this)">
        <button id="btnUpload" class="btn-pill btn-upload" onclick="triggerUpload()">
            <span>â˜ï¸ ä¸Šä¼  (Admin)</span>
        </button>
        
        <button class="btn-pill" onclick="openLocalSettings()"><span>âš™ï¸ è®¾ç½®</span></button>
    </div>

    <div id="loadingState">
        <div class="spinner"></div>
        <div>åŠ è½½ç”»å»Šæ•°æ®...</div>
    </div>

    <div class="gallery-container" id="galleryContainer"></div>
    <div class="pagination" id="pagination"></div>
    
    <div id="imageModal" class="modal preview-mode" onclick="if(event.target === this) closeModal()">
        <span class="close-modal" onclick="closeModal()">&times;</span>
        <button id="btnDelete" class="btn-delete" onclick="deleteCurrentImage()">ğŸ—‘ï¸ åˆ é™¤æ­¤å›¾</button>
        <img id="modalImg" src="" style="display:none;">
        <video id="modalVideo" src="" controls style="display:none;"></video>
        <div class="modal-caption" id="modalCaption"></div>
    </div>

    <div id="uploadConfigModal" class="modal modal-overlay-light">
        <div class="config-box">
            <h3 class="config-title">ğŸ“¤ ä¸Šä¼ å›¾ç‰‡</h3>
            <p style="margin:0; font-size:13px; color:#666;">å·²é€‰ <span id="fileCount" style="font-weight:bold;">0</span> ä¸ªæ–‡ä»¶</p>
            
            <label class="config-check-label">
                <input type="checkbox" id="isPromptExample" class="config-check-input" onchange="toggleExampleFields()">
                <span>ğŸ”— è®¾ä¸ºæç¤ºè¯ç¤ºä¾‹ (è‡ªåŠ¨é‡å‘½å)</span>
            </label>

            <div id="exampleFields" class="config-hidden-area">
                <div class="config-row">
                    <span class="config-label">æ ¸å¿ƒåç§° (Core Name) <span style="color:red">*</span></span>
                    <input type="text" id="coreNameInput" class="config-input" placeholder="ä¾‹å¦‚: Cyberpunk">
                </div>
                <div class="config-row">
                    <span class="config-label">ç‰ˆæœ¬å· (å¯é€‰)</span>
                    <input type="text" id="verNameInput" class="config-input" placeholder="ä¾‹å¦‚: v2.0">
                </div>
                <div style="font-size:11px; color:#999;">é¢„è§ˆ: <span id="filenamePreview">...</span></div>
            </div>

            <div class="config-actions">
                <button class="btn-cancel" onclick="closeUploadModal()">å–æ¶ˆ</button>
                <button class="btn-confirm" onclick="confirmUpload()">å¼€å§‹ä¸Šä¼ </button>
            </div>
        </div>
    </div>

    <div id="settingsModal" class="modal modal-overlay-light" onclick="if(event.target===this) closeLocalSettings()">
        <div class="config-box">
            <h3 class="config-title">âš™ï¸ ç”»å»Šé…ç½®</h3>
            <div class="config-row">
                <span class="config-label">GitHub Token <span style="color:red">*</span></span>
                <input type="password" id="confToken" class="config-input" placeholder="ghp_...">
            </div>
            <div class="config-row">
                <span class="config-label">ç”¨æˆ·å (Owner)</span>
                <input type="text" id="confOwner" class="config-input">
            </div>
            <div class="config-row">
                <span class="config-label">ä»“åº“å (Repo)</span>
                <input type="text" id="confRepo" class="config-input">
            </div>
            <div class="config-actions">
                <button class="btn-cancel" onclick="closeLocalSettings()">å–æ¶ˆ</button>
                <button class="btn-confirm" onclick="saveLocalSettings()">ğŸ’¾ ä¿å­˜å¹¶åˆ·æ–°</button>
            </div>
        </div>
    </div>

    <script>
        const REPO_CONFIG = { owner: 'itskys', repo: 'kayler', path: 'gallery', branch: 'main' };
        const ITEMS_PER_PAGE = 30;
        
        let allImages = [];      // æ‰€æœ‰å›¾ç‰‡å…ƒæ•°æ®
        let filteredImages = []; // æœç´¢/ç­›é€‰åçš„å›¾ç‰‡
        let currentPage = 1;
        let pendingFiles = [];
        let currentImgSHA = null, currentImgName = null;
        let currentTag = 'all';  // å½“å‰é€‰ä¸­æ ‡ç­¾

        // DOM Elements
        const galleryContainer = document.getElementById('galleryContainer');
        const loadingState = document.getElementById('loadingState');
        const pagination = document.getElementById('pagination');
        const tagsContainer = document.getElementById('tagsContainer');
        const searchInput = document.getElementById('searchInput');
        const modal = document.getElementById('imageModal');
        const modalImg = document.getElementById('modalImg');
        const modalVideo = document.getElementById('modalVideo');
        const modalCaption = document.getElementById('modalCaption');
        const btnUpload = document.getElementById('btnUpload');
        const btnDelete = document.getElementById('btnDelete');
        const toast = document.getElementById('upload-toast');
        const uploadModal = document.getElementById('uploadConfigModal');
        const settingsModal = document.getElementById('settingsModal');

        // === 1. åˆå§‹åŒ–ä¸æ•°æ® ===
        function checkAdmin() {
            if(localStorage.getItem('gh_token')) {
                btnUpload.style.display = 'inline-flex';
                btnDelete.dataset.auth = "true";
            } else {
                btnUpload.style.display = 'none';
                btnDelete.style.display = 'none';
                btnDelete.dataset.auth = "false";
            }
        }
        window.addEventListener('auth-updated', checkAdmin);

        async function initGallery() {
            loadingState.style.display = 'flex'; galleryContainer.innerHTML = ''; pagination.innerHTML = ''; tagsContainer.innerHTML = '';
            const token = localStorage.getItem('gh_token');
            const headers = token ? { 'Authorization': `token ${token}` } : {};
            const owner = localStorage.getItem('gh_owner') || REPO_CONFIG.owner;
            const repo = localStorage.getItem('gh_repo') || REPO_CONFIG.repo;

            try {
                // ä¿®æ”¹é¡µé¢æ ‡é¢˜ (å…¼å®¹Layoutæ³¨å…¥çš„å¯¼èˆª)
                document.title = "AI ç”»å»Š - Kayler";
                
                const url = `https://api.github.com/repos/${owner}/${repo}/contents/${REPO_CONFIG.path}?ref=${REPO_CONFIG.branch}&t=${Date.now()}`;
                const response = await fetch(url, { headers });
                if (!response.ok) throw new Error((await response.text()));
                
                const files = await response.json();
                const validExtensions = ['.jpg', '.jpeg', '.png', '.gif', '.webp', '.mp4'];
                allImages = files.filter(file => validExtensions.some(ext => file.name.toLowerCase().endsWith(ext)));
                allImages.sort((a, b) => b.name.localeCompare(a.name)); // æŒ‰æ—¶é—´å€’åº

                if (allImages.length === 0) { loadingState.innerHTML = "æš‚æ— å†…å®¹"; return; }
                
                // åˆå§‹åŒ–æ ‡ç­¾ç³»ç»Ÿ
                generateTags();
                
                // é»˜è®¤æ˜¾ç¤ºå…¨éƒ¨
                filteredImages = [...allImages];
                renderPage(1);
                loadingState.style.display = 'none';
            } catch (error) {
                loadingState.innerHTML = `<span style="color:red">âš ï¸ åŠ è½½å¤±è´¥: ${error.message}</span><br><button class="btn-pill" onclick="initGallery()">é‡è¯•</button>`;
            }
        }

        // === 2. æ ‡ç­¾ä¸æœç´¢ (v12.0 æ ¸å¿ƒ) ===
        function generateTags() {
            const tagCounts = {};
            allImages.forEach(img => {
                // è§£ææ–‡ä»¶å: 20251218123456_Cyberpunk_v1_...
                // ç­–ç•¥ï¼šå»é™¤æ—¶é—´æˆ³å‰ç¼€ï¼Œå–ç¬¬ä¸€ä¸ªä¸‹åˆ’çº¿å‰çš„å•è¯ä½œä¸ºæ ‡ç­¾
                const cleanName = img.name.replace(/^\d{14}_/, '');
                const parts = cleanName.split(/_| /); // æŒ‰ä¸‹åˆ’çº¿æˆ–ç©ºæ ¼åˆ†å‰²
                if (parts.length > 0) {
                    const tag = parts[0];
                    // è¿‡æ»¤æ‰å¤ªçŸ­çš„æˆ–æ— å…³çš„è¯
                    if(tag.length > 2 && !tag.toLowerCase().startsWith('img') && !tag.toLowerCase().startsWith('pic')) {
                        tagCounts[tag] = (tagCounts[tag] || 0) + 1;
                    }
                }
            });

            // æ’åºå¹¶å–å‰15ä¸ªçƒ­é—¨æ ‡ç­¾
            const sortedTags = Object.keys(tagCounts).sort((a,b) => tagCounts[b] - tagCounts[a]).slice(0, 15);
            
            let html = `<div class="filter-tag active" onclick="filterByTag('all', this)">å…¨éƒ¨ (${allImages.length})</div>`;
            sortedTags.forEach(tag => {
                html += `<div class="filter-tag" onclick="filterByTag('${tag}', this)">${tag} (${tagCounts[tag]})</div>`;
            });
            tagsContainer.innerHTML = html;
        }

        function filterByTag(tag, btnElement) {
            currentTag = tag;
            // UI æ›´æ–°
            document.querySelectorAll('.filter-tag').forEach(el => el.classList.remove('active'));
            if(btnElement) btnElement.classList.add('active');
            
            // æ•°æ®ç­›é€‰
            if (tag === 'all') {
                filteredImages = [...allImages];
            } else {
                filteredImages = allImages.filter(img => img.name.toLowerCase().includes(tag.toLowerCase()));
            }
            
            // é‡ç½®æœç´¢æ¡†
            searchInput.value = '';
            renderPage(1);
        }

        function handleSearch() {
            const query = searchInput.value.toLowerCase();
            document.querySelectorAll('.filter-tag').forEach(el => el.classList.remove('active')); // æ¸…é™¤æ ‡ç­¾é€‰ä¸­
            
            if (!query) {
                filterByTag('all', document.querySelector('.filter-tag')); // æ¢å¤é»˜è®¤
                return;
            }

            filteredImages = allImages.filter(img => img.name.toLowerCase().includes(query));
            renderPage(1);
        }

        // === 3. æ¸²æŸ“ä¸åˆ†é¡µ ===
        function renderPage(page) {
            currentPage = page;
            const start = (page - 1) * ITEMS_PER_PAGE;
            const end = start + ITEMS_PER_PAGE;
            const pageImages = filteredImages.slice(start, end);
            
            renderImages(pageImages);
            renderPagination();
            if (page > 1) document.querySelector('header').scrollIntoView({ behavior: 'smooth' });
        }

        function renderImages(images) {
            galleryContainer.innerHTML = '';
            const owner = localStorage.getItem('gh_owner') || REPO_CONFIG.owner;
            const repo = localStorage.getItem('gh_repo') || REPO_CONFIG.repo;
            
            if(images.length === 0) {
                galleryContainer.innerHTML = '<div style="text-align:center; color:#ccc; width:100%;">æœªæ‰¾åˆ°åŒ¹é…å›¾ç‰‡</div>';
                return;
            }

            images.forEach(img => {
                // æ¸…ç†æ˜¾ç¤ºæ ‡é¢˜
                const title = img.name.replace(/^\d{14}_/, "").replace(/\.[^/.]+$/, "").replace(/_/g, " "); 
                const rawUrl = `https://raw.githubusercontent.com/${owner}/${repo}/${REPO_CONFIG.branch}/${REPO_CONFIG.path}/${encodeURIComponent(img.name)}`;
                const item = document.createElement('div');
                item.className = 'gallery-item';
                
                let mediaTag = `<img src="${rawUrl}" alt="${title}" loading="lazy">`;
                let type = 'image';
                if(img.name.endsWith('.mp4')) {
                    mediaTag = `<video src="${rawUrl}" muted autoplay loop style="width:100%; display:block;"></video>`;
                    type = 'video';
                }

                item.onclick = () => openModal(rawUrl, title, type, img.sha, img.name);
                item.innerHTML = `
                    ${mediaTag}
                    <div class="item-info">
                        <div class="item-title">${title}</div>
                        <div class="item-meta"><span>Kayler AI</span><span>ğŸ“¥ æŸ¥çœ‹</span></div>
                    </div>`;
                galleryContainer.appendChild(item);
            });
        }

        function renderPagination() {
            pagination.innerHTML = '';
            const totalPages = Math.ceil(filteredImages.length / ITEMS_PER_PAGE);
            if (totalPages <= 1) return;
            
            const prevBtn = createPageBtn('â†', () => renderPage(currentPage - 1));
            prevBtn.disabled = currentPage === 1; pagination.appendChild(prevBtn);
            
            // ç®€å•åˆ†é¡µé€»è¾‘ï¼šæ˜¾ç¤ºå½“å‰é¡µé™„è¿‘
            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
                    const btn = createPageBtn(i, () => renderPage(i));
                    if (i === currentPage) btn.classList.add('active');
                    pagination.appendChild(btn);
                } else if ((i === currentPage - 3 && currentPage > 4) || (i === currentPage + 3 && currentPage < totalPages - 3)) {
                    const span = document.createElement('span'); span.innerText = '...'; span.style.color = '#ccc'; pagination.appendChild(span);
                }
            }
            
            const nextBtn = createPageBtn('â†’', () => renderPage(currentPage + 1));
            nextBtn.disabled = currentPage === totalPages; pagination.appendChild(nextBtn);
        }

        function createPageBtn(text, onClick) {
            const btn = document.createElement('button'); btn.className = 'page-btn'; btn.innerText = text; btn.onclick = onClick; return btn;
        }

        // === 4. æ¨¡æ€æ¡†ä¸åˆ é™¤ ===
        function openModal(src, caption, type, sha, filename) {
            modalCaption.innerText = caption;
            currentImgSHA = sha; currentImgName = filename;
            
            if (btnDelete.dataset.auth === "true") {
                btnDelete.style.display = "block";
                btnDelete.innerText = "ğŸ—‘ï¸ åˆ é™¤æ­¤å›¾"; btnDelete.disabled = false;
            } else { btnDelete.style.display = "none"; }

            modal.classList.add('active');
            if(type === 'video') {
                modalImg.style.display = 'none'; modalVideo.style.display = 'block';
                modalVideo.src = src; modalVideo.play();
            } else {
                modalVideo.style.display = 'none'; modalVideo.pause();
                modalImg.style.display = 'block'; modalImg.src = src;
            }
        }
        function closeModal() { modal.classList.remove('active'); modalVideo.pause(); }

        async function deleteCurrentImage() {
            if(!confirm(`ç¡®å®šè¦æ°¸ä¹…åˆ é™¤æ­¤å›¾ç‰‡å—ï¼Ÿ`)) return;
            const token = localStorage.getItem('gh_token');
            const owner = localStorage.getItem('gh_owner') || REPO_CONFIG.owner;
            const repo = localStorage.getItem('gh_repo') || REPO_CONFIG.repo;
            btnDelete.innerText = "â³..."; btnDelete.disabled = true;

            try {
                const url = `https://api.github.com/repos/${owner}/${repo}/contents/${REPO_CONFIG.path}/${currentImgName}`;
                await fetch(url, {
                    method: 'DELETE',
                    headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: `Delete ${currentImgName}`, sha: currentImgSHA, branch: 'main' })
                });
                alert("âœ… åˆ é™¤æˆåŠŸ"); closeModal();
                setTimeout(initGallery, 1000); 
            } catch(e) { alert("åˆ é™¤å¤±è´¥: " + e.message); btnDelete.disabled = false; }
        }

        // === 5. é…ç½®ä¸ä¸Šä¼  ===
        function openLocalSettings() {
            document.getElementById('confToken').value = localStorage.getItem('gh_token') || '';
            document.getElementById('confOwner').value = localStorage.getItem('gh_owner') || 'itskys';
            document.getElementById('confRepo').value = localStorage.getItem('gh_repo') || 'kayler';
            settingsModal.classList.add('active');
        }
        function closeLocalSettings() { settingsModal.classList.remove('active'); }
        function saveLocalSettings() {
            localStorage.setItem('gh_token', document.getElementById('confToken').value.trim());
            localStorage.setItem('gh_owner', document.getElementById('confOwner').value.trim());
            localStorage.setItem('gh_repo', document.getElementById('confRepo').value.trim());
            closeLocalSettings(); checkAdmin(); initGallery();
        }

        function triggerUpload() { document.getElementById('imgUploadInput').click(); }
        function prepareUpload(input) {
            if(input.files.length===0) return;
            pendingFiles = Array.from(input.files);
            document.getElementById('fileCount').innerText = pendingFiles.length;
            document.getElementById('isPromptExample').checked = false;
            document.getElementById('coreNameInput').value = '';
            document.getElementById('verNameInput').value = '';
            toggleExampleFields();
            uploadModal.classList.add('active'); input.value='';
        }
        function toggleExampleFields() {
            const isChecked = document.getElementById('isPromptExample').checked;
            document.getElementById('exampleFields').style.display = isChecked ? 'flex' : 'none';
            updateFilenamePreview();
        }
        function updateFilenamePreview() {
            const core = document.getElementById('coreNameInput').value || 'Name';
            const ver = document.getElementById('verNameInput').value;
            const verStr = ver ? `_${ver}` : '';
            document.getElementById('filenamePreview').innerText = `2025..._${core}${verStr}_åŸå.png`;
        }
        document.getElementById('coreNameInput').addEventListener('input', updateFilenamePreview);
        document.getElementById('verNameInput').addEventListener('input', updateFilenamePreview);
        function closeUploadModal() { uploadModal.classList.remove('active'); }

        async function confirmUpload() {
            const isExample = document.getElementById('isPromptExample').checked;
            const coreName = document.getElementById('coreNameInput').value.trim();
            const verName = document.getElementById('verNameInput').value.trim();
            if (isExample && !coreName) { alert("è¯·è¾“å…¥æ ¸å¿ƒåç§°"); return; }
            closeUploadModal(); toast.style.display='block';
            
            const token = localStorage.getItem('gh_token');
            const owner = localStorage.getItem('gh_owner') || REPO_CONFIG.owner;
            const repo = localStorage.getItem('gh_repo') || REPO_CONFIG.repo;
            let success = 0;

            const promises = pendingFiles.map(async (file) => {
                try {
                    const base64 = await new Promise(r => { const reader=new FileReader(); reader.onload=()=>r(reader.result.split(',')[1]); reader.readAsDataURL(file); });
                    const ts = new Date().toISOString().replace(/[-:T.]/g, '').slice(0, 14);
                    const cleanName = file.name.replace(/\s+/g, '_');
                    let filename = `${ts}_${cleanName}`;
                    
                    if (isExample) {
                        const safeCore = coreName.replace(/[^a-zA-Z0-9_\u4e00-\u9fa5]/g, '');
                        const verStr = verName ? `_${verName}` : '';
                        filename = `${ts}_${safeCore}${verStr}_${cleanName}`;
                    }
                    
                    const url = `https://api.github.com/repos/${owner}/${repo}/contents/${REPO_CONFIG.path}/${filename}`;
                    await fetch(url, { method: 'PUT', headers: {'Authorization':`token ${token}`,'Content-Type':'application/json'}, body: JSON.stringify({message:`Upload ${filename}`, content:base64, branch:'main'}) });
                    success++;
                } catch(e) { console.error(e); }
            });

            await Promise.all(promises);
            toast.style.display='none';
            if(success>0) { alert(`æˆåŠŸä¸Šä¼  ${success} ä¸ªæ–‡ä»¶`); setTimeout(initGallery, 1000); }
        }

        checkAdmin();
        initGallery();
    </script>
</body>
</html>