<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI å›¾ç‰‡å±• - Kayler</title>
    <link rel="icon" href="/favicon.png" type="image/png">
    
    <script src="layout.js?v=5.1"></script>

    <style>
        :root {
            --bg-body: #f2f4f7; --brand-brown: #8b5e3c; --brand-brown-hover: #6d4c41;
            --card-shadow: 0 4px 20px rgba(0,0,0,0.05);
            --layout-width: 94%; --layout-max-width: 1600px;
        }
        body {
            font-family: "PingFang SC", "Microsoft YaHei", sans-serif;
            background-color: var(--bg-body); margin: 0; padding: 20px;
            display: flex; flex-direction: column; align-items: center;
            min-height: 100vh; color: #333;
        }
        header { text-align: center; margin-bottom: 30px; margin-top: 10px; }
        h1 { font-size: 32px; font-weight: 800; margin-bottom: 10px; display: flex; align-items: center; justify-content: center; }
        
        /* é¡¶éƒ¨æ“ä½œåŒº */
        .action-area {
            display: flex; flex-direction: column; align-items: center; gap: 15px; margin-bottom: 30px;
            width: 100%; max-width: 800px;
        }
        .action-bar { display: flex; justify-content: center; gap: 15px; }
        .btn-pill {
            padding: 8px 20px; border-radius: 50px; border: 1px solid #ddd;
            background: white; color: #666; cursor: pointer; font-size: 14px;
            display: flex; align-items: center; gap: 6px; transition: all 0.2s;
        }
        .btn-pill:hover { border-color: var(--brand-brown); color: var(--brand-brown); transform: translateY(-1px); }
        .btn-upload { background: var(--brand-brown); color: white; border-color: var(--brand-brown); display: none; }
        .btn-upload:hover { background: var(--brand-brown-hover); color: white; }

        /* ä¸Šä¼ æç¤º (v9.0 æ–°å¢) */
        .upload-tip {
            background: #fff3e0; border: 1px solid #ffe0b2; color: #e65100;
            padding: 10px 20px; border-radius: 8px; font-size: 12px; line-height: 1.5;
            text-align: center; display: none; /* é»˜è®¤éšè—ï¼Œæœ‰æƒé™æ‰æ˜¾ç¤º */
        }
        .upload-tip code { background: rgba(255,255,255,0.5); padding: 0 4px; border-radius: 3px; font-family: monospace; font-weight: bold; }

        /* ç€‘å¸ƒæµå¸ƒå±€ */
        .gallery-container { column-count: 5; column-gap: 20px; width: var(--layout-width); max-width: var(--layout-max-width); min-height: 600px; }
        .gallery-item {
            background: white; border-radius: 12px; margin-bottom: 20px; overflow: hidden; break-inside: avoid;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); transition: transform 0.3s, box-shadow 0.3s; 
            cursor: zoom-in; position: relative; opacity: 0; animation: fadeIn 0.5s forwards;
        }
        .gallery-item:hover { transform: translateY(-5px); box-shadow: 0 8px 25px rgba(0,0,0,0.1); }
        .gallery-item img { width: 100%; height: auto; display: block; background: #eee; min-height: 150px; }
        .item-info { padding: 15px; border-top: 1px solid #f5f5f5; }
        .item-title { font-size: 14px; font-weight: bold; color: #333; margin-bottom: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .item-meta { font-size: 12px; color: #999; display: flex; justify-content: space-between; }

        .pagination { display: flex; justify-content: center; align-items: center; gap: 8px; margin-top: 40px; margin-bottom: 20px; flex-wrap: wrap; }
        .page-btn { padding: 8px 14px; border: 1px solid #ddd; background: white; color: #555; border-radius: 6px; cursor: pointer; font-size: 14px; transition: all 0.2s; min-width: 36px; text-align: center; }
        .page-btn:hover:not(:disabled) { border-color: var(--brand-brown); color: var(--brand-brown); }
        .page-btn.active { background: var(--brand-brown); color: white; border-color: var(--brand-brown); }
        .page-btn:disabled { background: #f5f5f5; color: #ccc; cursor: not-allowed; border-color: #eee; }

        #loadingState { width: 100%; text-align: center; color: #999; margin-top: 50px; display: flex; flex-direction: column; align-items: center; gap: 10px; }
        .spinner { width: 30px; height: 30px; border: 3px solid #eee; border-top: 3px solid var(--brand-brown); border-radius: 50%; animation: spin 1s linear infinite; }
        #upload-toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); color: white; padding: 12px 25px; border-radius: 30px; font-size: 14px; z-index: 9999; display: none; }

        .modal { display: none; position: fixed; z-index: 2000; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); justify-content: center; align-items: center; flex-direction: column; backdrop-filter: blur(5px); }
        .modal.active { display: flex; }
        .modal img, .modal video { max-width: 90%; max-height: 80vh; border-radius: 4px; box-shadow: 0 0 30px rgba(0,0,0,0.5); object-fit: contain; }
        .modal-caption { color: #ccc; margin-top: 20px; font-size: 16px; text-align: center; max-width: 80%; }
        .close-modal { position: absolute; top: 30px; right: 30px; color: white; font-size: 40px; cursor: pointer; transition: 0.2s; }
        .close-modal:hover { color: var(--brand-brown); }
        
        .admin-link { color: #ddd; text-decoration: none; font-size: 12px; cursor: pointer; }
        .admin-link:hover { color: var(--brand-brown); text-decoration: underline; }
        
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes fadeIn { to { opacity: 1; } }
        @media (max-width: 1600px) { .gallery-container { column-count: 4; } }
        @media (max-width: 1200px) { .gallery-container { column-count: 3; } }
        @media (max-width: 900px) { .gallery-container { column-count: 2; } }
        @media (max-width: 600px) { .gallery-container { column-count: 1; } }
    </style>
</head>
<body>
    
    <div id="upload-toast">â³ æ­£åœ¨ä¸Šä¼ ...</div>

    <header>
        <h1><img src="/logo.png" alt="Logo" style="height: 36px; vertical-align: middle; margin-right: 8px;">Kayler AI è‰ºæœ¯é¦†</h1>
        <p style="color:#888">ç²¾é€‰ AI ç”Ÿæˆä½œå“å±•ç¤º</p>
    </header>

    <div class="action-area">
        <div id="uploadTip" class="upload-tip">
            <strong>âš ï¸ å…³è”æç¤ºï¼š</strong>ä¸Šä¼ å‰è¯·ç¡®ä¿æ–‡ä»¶ååŒ…å«å¯¹åº”çš„ <code>æ ¸å¿ƒåç§°</code>ã€‚<br>
            å¦‚éœ€æŒ‡å®šç‰ˆæœ¬ï¼Œè¯·åŒ…å«ç‰ˆæœ¬å·ï¼ˆå¦‚ <code>_v2_</code>ï¼‰ã€‚ä¾‹ï¼š<code>Concept_v2_001.png</code>
        </div>

        <div class="action-bar">
            <button class="btn-pill" onclick="initGallery()"><span>ğŸ”„ åˆ·æ–°ç”»å»Š</span></button>
            <input type="file" id="imgUploadInput" accept="image/*,video/mp4" multiple style="display:none;" onchange="processUploads(this)">
            <button id="btnUpload" class="btn-pill btn-upload" onclick="triggerUpload()">
                <span>â˜ï¸ ä¸Šä¼ å›¾ç‰‡ (Admin)</span>
            </button>
        </div>
    </div>

    <div id="loadingState">
        <div class="spinner"></div>
        <div>æ­£åœ¨ä» GitHub è·å–æœ€æ–°ä½œå“...</div>
    </div>

    <div class="gallery-container" id="galleryContainer"></div>
    <div class="pagination" id="pagination"></div>
    
    <div style="margin-top: 40px; text-align: center;">
        <a onclick="openGlobalSettings()" class="admin-link">âš™ï¸ ç”»å»Šé…ç½®</a>
    </div>

    <div id="imageModal" class="modal" onclick="if(event.target === this) closeModal()">
        <span class="close-modal" onclick="closeModal()">&times;</span>
        <img id="modalImg" src="" style="display:none;">
        <video id="modalVideo" src="" controls style="display:none;"></video>
        <div class="modal-caption" id="modalCaption"></div>
    </div>

    <script>
        const REPO_CONFIG = { owner: 'itskys', repo: 'kayler', path: 'gallery', branch: 'main' };
        const ITEMS_PER_PAGE = 30;
        let allImages = [];
        let currentPage = 1;

        const galleryContainer = document.getElementById('galleryContainer');
        const loadingState = document.getElementById('loadingState');
        const pagination = document.getElementById('pagination');
        const modal = document.getElementById('imageModal');
        const modalImg = document.getElementById('modalImg');
        const modalVideo = document.getElementById('modalVideo');
        const modalCaption = document.getElementById('modalCaption');
        const btnUpload = document.getElementById('btnUpload');
        const uploadTip = document.getElementById('uploadTip');
        const toast = document.getElementById('upload-toast');

        function checkAdmin() {
            if(localStorage.getItem('gh_token')) {
                btnUpload.style.display = 'inline-flex';
                uploadTip.style.display = 'block'; 
            } else {
                btnUpload.style.display = 'none';
                uploadTip.style.display = 'none';
            }
        }
        window.addEventListener('auth-updated', checkAdmin);

        function triggerUpload() { document.getElementById('imgUploadInput').click(); }

        async function processUploads(input) {
            const files = input.files;
            if(files.length === 0) return;
            if(files.length > 3) { alert("âš ï¸ å•æ¬¡æœ€å¤šåªèƒ½ä¸Šä¼  3 ä¸ªæ–‡ä»¶ï¼"); input.value = ''; return; }

            const token = localStorage.getItem('gh_token');
            const owner = localStorage.getItem('gh_owner') || REPO_CONFIG.owner;
            const repo = localStorage.getItem('gh_repo') || REPO_CONFIG.repo;

            if(!token) { alert("Token ä¸¢å¤±ï¼Œè¯·é‡æ–°ç™»å½•"); return; }
            toast.style.display = 'block';
            let successCount = 0;

            const uploadPromises = Array.from(files).map(async (file) => {
                try {
                    const contentBase64 = await toBase64(file);
                    const timestamp = new Date().toISOString().replace(/[-:T.]/g, '').slice(0, 14);
                    const safeName = file.name.replace(/\s+/g, '_'); 
                    const filename = `${timestamp}_${safeName}`;
                    const path = `${REPO_CONFIG.path}/${filename}`;

                    const url = `https://api.github.com/repos/${owner}/${repo}/contents/${path}`;
                    const res = await fetch(url, {
                        method: 'PUT',
                        headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' },
                        body: JSON.stringify({ message: `Upload gallery: ${filename}`, content: contentBase64, branch: 'main' })
                    });
                    if(!res.ok) throw new Error((await res.json()).message);
                    successCount++;
                } catch(e) { console.error(e); alert(`âŒ ${file.name} ä¸Šä¼ å¤±è´¥: ${e.message}`); }
            });

            await Promise.all(uploadPromises);
            toast.style.display = 'none';
            input.value = ''; 
            if(successCount > 0) {
                alert(`âœ… æˆåŠŸä¸Šä¼  ${successCount} ä¸ªæ–‡ä»¶ï¼\nç”»å»Šæ­£åœ¨åˆ·æ–°...`);
                setTimeout(initGallery, 1000);
            }
        }

        function toBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = error => reject(error);
            });
        }

        async function initGallery() {
            loadingState.style.display = 'flex'; galleryContainer.innerHTML = ''; pagination.innerHTML = '';
            const token = localStorage.getItem('gh_token');
            const headers = token ? { 'Authorization': `token ${token}` } : {};
            const owner = localStorage.getItem('gh_owner') || REPO_CONFIG.owner;
            const repo = localStorage.getItem('gh_repo') || REPO_CONFIG.repo;

            try {
                const url = `https://api.github.com/repos/${owner}/${repo}/contents/${REPO_CONFIG.path}?ref=${REPO_CONFIG.branch}&t=${Date.now()}`;
                const response = await fetch(url, { headers });
                if (!response.ok) throw new Error((await response.text()));
                
                const files = await response.json();
                const validExtensions = ['.jpg', '.jpeg', '.png', '.gif', '.webp', '.mp4'];
                allImages = files.filter(file => validExtensions.some(ext => file.name.toLowerCase().endsWith(ext)));

                if (allImages.length === 0) { loadingState.innerHTML = "æš‚æ— å†…å®¹ï¼Œè¯·å…ˆä¸Šä¼ åˆ° /gallery ç›®å½•"; return; }
                allImages.sort((a, b) => b.name.localeCompare(a.name));
                renderPage(1);
                loadingState.style.display = 'none';
            } catch (error) {
                let msg = error.message;
                if (msg.includes("403")) msg = "API è®¿é—®é¢‘ç‡è¶…é™ã€‚è¯·é…ç½® Tokenã€‚";
                if (msg.includes("404")) msg = "æ— æ³•è¯»å– gallery ç›®å½•ã€‚";
                loadingState.innerHTML = `<span style="color:red; line-height:1.6;">âš ï¸ åŠ è½½å¤±è´¥<br>${msg}</span><br><br><button class="btn-pill" onclick="initGallery()">é‡è¯•</button>`;
            }
        }

        function renderPage(page) {
            currentPage = page;
            const start = (page - 1) * ITEMS_PER_PAGE;
            const end = start + ITEMS_PER_PAGE;
            const pageImages = allImages.slice(start, end);
            renderImages(pageImages);
            renderPagination();
            if (page > 1) document.querySelector('header').scrollIntoView({ behavior: 'smooth' });
        }

        function renderImages(images) {
            galleryContainer.innerHTML = '';
            const owner = localStorage.getItem('gh_owner') || REPO_CONFIG.owner;
            const repo = localStorage.getItem('gh_repo') || REPO_CONFIG.repo;
            
            images.forEach(img => {
                // æ¸…ç†æ–‡ä»¶å: å»é™¤æ—¶é—´æˆ³å‰ç¼€(14ä½+_)
                const title = img.name.replace(/^\d{14}_/, "").replace(/\.[^/.]+$/, "").replace(/_/g, " "); 
                const rawUrl = `https://raw.githubusercontent.com/${owner}/${repo}/${REPO_CONFIG.branch}/${REPO_CONFIG.path}/${encodeURIComponent(img.name)}`;
                const item = document.createElement('div');
                item.className = 'gallery-item';
                
                // åˆ¤æ–­ç±»å‹
                let mediaTag = `<img src="${rawUrl}" alt="${title}" loading="lazy">`;
                let type = 'image';
                if(img.name.endsWith('.mp4')) {
                    mediaTag = `<video src="${rawUrl}" muted autoplay loop style="width:100%; display:block;"></video>`;
                    type = 'video';
                }

                item.onclick = () => openModal(rawUrl, title, type);
                item.innerHTML = `
                    ${mediaTag}
                    <div class="item-info">
                        <div class="item-title">${title}</div>
                        <div class="item-meta"><span>Kayler AI</span><span>ğŸ“¥ æŸ¥çœ‹</span></div>
                    </div>`;
                galleryContainer.appendChild(item);
            });
        }

        function renderPagination() {
            pagination.innerHTML = '';
            const totalPages = Math.ceil(allImages.length / ITEMS_PER_PAGE);
            if (totalPages <= 1) return;
            const prevBtn = createPageBtn('â†', () => renderPage(currentPage - 1));
            prevBtn.disabled = currentPage === 1; pagination.appendChild(prevBtn);
            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
                    const btn = createPageBtn(i, () => renderPage(i));
                    if (i === currentPage) btn.classList.add('active');
                    pagination.appendChild(btn);
                } else if ((i === currentPage - 3 && currentPage > 4) || (i === currentPage + 3 && currentPage < totalPages - 3)) {
                    const span = document.createElement('span'); span.innerText = '...'; span.style.color = '#ccc'; pagination.appendChild(span);
                }
            }
            const nextBtn = createPageBtn('â†’', () => renderPage(currentPage + 1));
            nextBtn.disabled = currentPage === totalPages; pagination.appendChild(nextBtn);
        }

        function createPageBtn(text, onClick) {
            const btn = document.createElement('button'); btn.className = 'page-btn'; btn.innerText = text; btn.onclick = onClick; return btn;
        }

        function openModal(src, caption, type) {
            modalCaption.innerText = caption;
            modal.classList.add('active');
            if(type === 'video') {
                modalImg.style.display = 'none';
                modalVideo.style.display = 'block';
                modalVideo.src = src;
                modalVideo.play();
            } else {
                modalVideo.style.display = 'none';
                modalVideo.pause();
                modalImg.style.display = 'block';
                modalImg.src = src;
            }
        }
        
        function closeModal() { 
            modal.classList.remove('active'); 
            modalVideo.pause();
        }

        function openGlobalSettings() { window.openGlobalSettings(); }
        function closeSettings() { window.closeGlobalSettings(); }

        checkAdmin();
        initGallery();
    </script>
</body>
</html>