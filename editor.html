<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta property="og:image" content="https://x.aisai.cc/social-cover.png">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åœ¨çº¿ Markdown ç¼–è¾‘å™¨ - Kayler</title>
    <link rel="icon" href="/favicon.png" type="image/png">
    
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <script src="layout.js"></script>
    
    <style>
        :root { 
            --brand-brown: #8b5e3c; 
            --brand-brown-hover: #6d4c41;
            --bg-body: #f2f4f7;
            --layout-width: 94%;
            --layout-max-width: 1600px;
        }
        * { box-sizing: border-box; }
        
        /* === å¸ƒå±€åŸºç¡€ === */
        html, body {
            margin: 0; padding: 0;
            height: 100%; 
            font-family: "PingFang SC", "Microsoft YaHei", sans-serif;
            background: var(--bg-body); color: #333;
        }
        
        /* å¹³æ—¶ï¼šç¦æ­¢æ»šåŠ¨ï¼Œåº”ç”¨ Flex å¸ƒå±€ */
        body { overflow: hidden; display: flex; flex-direction: column; }

        /* å¯¼å‡ºæ¨¡å¼ï¼šå…è®¸æ»šåŠ¨ (PDFç”Ÿæˆç”¨) */
        body.export-mode {
            overflow: visible !important;
            height: auto !important;
            background: white !important;
            display: block !important;
        }

        /* === ä¸»åº”ç”¨å®¹å™¨ === */
        #main-app {
            display: flex; flex-direction: column; height: 100%; width: 100%;
        }

        /* å¤´éƒ¨å·¥å…·æ  */
        .header-wrapper {
            flex-shrink: 0; 
            width: var(--layout-width); max-width: var(--layout-max-width); 
            margin: 15px auto; 
            background: white; padding: 12px 20px; border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.03);
            display: flex; justify-content: space-between; align-items: center;
        }

        .header-left h1 { 
            font-size: 20px; margin: 0; font-weight: 800; color: #222; 
            display: flex; align-items: center; gap: 10px;
        }

        .header-right { display: flex; gap: 10px; align-items: center; }

        .filename-tag {
            font-size: 13px; color: #888; background: #f5f5f5; 
            padding: 6px 12px; border-radius: 6px; font-family: monospace; border: 1px solid #eee;
        }

        .btn {
            padding: 8px 15px; border-radius: 6px; border: none; cursor: pointer; font-size: 13px; font-weight: bold;
            display: flex; align-items: center; gap: 5px; transition: all 0.2s;
        }
        .btn-primary { background: #333; color: white; }
        .btn-pdf { background: #d32f2f; color: white; }
        .btn-magic { background: var(--brand-brown); color: white; }
        .btn-cloud { background: #2e7d32; color: white; } 
        .btn:hover { opacity: 0.9; transform: translateY(-1px); }

        /* === ä¸»å·¥ä½œåŒº === */
        .workspace-container {
            flex: 1; width: 100%; display: flex; justify-content: center;
            overflow: hidden; padding-bottom: 10px;
        }

        .workspace { 
            width: var(--layout-width); max-width: var(--layout-max-width);
            height: 100%; display: flex; 
            background: white; border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.05); 
            overflow: hidden; border: 1px solid #e0e0e0;
        }
        
        .pane { 
            width: 50%; height: 100%; position: relative;
        }

        /* å·¦ä¾§ç¼–è¾‘å™¨ */
        .pane-editor { overflow: hidden; padding: 0; }
        
        #editor {
            width: 100%; height: 100%; 
            border: none; border-right: 1px solid #eee;
            resize: none; outline: none; 
            font-family: "Menlo", "Monaco", monospace;
            font-size: 15px; line-height: 1.7; 
            padding: 30px; 
            color: #333; background: white; display: block; 
            overflow-y: auto; /* å…³é”®ï¼šå†…éƒ¨æ»šåŠ¨ */
            box-sizing: border-box;
        }
        #editor.placeholder-mode { color: #aaa; }

        /* å³ä¾§é¢„è§ˆåŒº */
        #preview { 
            background: #fdfbf7; color: #333; padding: 30px 40px; 
            overflow-y: auto; 
        }
        
        /* Markdown æ¸²æŸ“æ ·å¼ */
        .markdown-body h1 { border-bottom: 2px solid #e0e0e0; padding-bottom: 10px; font-size: 26px; margin-top: 0; color: #000; }
        .markdown-body h2 { border-bottom: 1px solid #e0e0e0; padding-bottom: 8px; font-size: 20px; margin-top: 25px; color: #333; }
        .markdown-body blockquote { border-left: 4px solid var(--brand-brown); padding-left: 15px; color: #666; background: rgba(139, 94, 60, 0.05); padding: 10px; margin: 15px 0; }
        .markdown-body code { background: #eee; padding: 2px 5px; border-radius: 4px; font-family: monospace; color: #c7254e; font-size: 0.9em; }
        .markdown-body pre { background: #282c34; color: #abb2bf; padding: 15px; border-radius: 8px; overflow-x: auto; }
        .markdown-body pre code { color: inherit; background: transparent; padding: 0; }
        .markdown-body img { max-width: 100%; border-radius: 6px; }
        .markdown-body table { width: 100%; border-collapse: collapse; margin: 15px 0; }
        .markdown-body th, .markdown-body td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        .markdown-body th { background: #f0f0f0; font-weight: bold; }

        footer {
            height: 40px; background: white; border-top: 1px solid #ddd;
            display: flex; justify-content: center; align-items: center;
            font-size: 12px; color: #999; flex-shrink: 0;
        }

        /* === PDF ä¸“ç”¨èˆå° (å¹³æ—¶éšè—) === */
        #pdf-stage { display: none; width: 100%; margin: 0; background: white !important; padding: 0; color: black; font-family: "SimSun", "Times New Roman", serif; }
        #pdf-stage * { color: black !important; background-color: transparent !important; }
        #pdf-stage p, #pdf-stage pre, #pdf-stage blockquote, #pdf-stage ul, #pdf-stage ol, #pdf-stage table, #pdf-stage h1, #pdf-stage h2, #pdf-stage h3 { page-break-inside: avoid; break-inside: avoid; }
        #pdf-stage h1 { font-size: 24pt; border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 20px; }
        #pdf-stage h2 { font-size: 18pt; border-bottom: 1px solid #ccc; margin-top: 30px; page-break-after: avoid; }
        #pdf-stage p { font-size: 12pt; line-height: 1.6; margin-bottom: 10px; text-align: justify; }
        #pdf-stage pre { border: 1px solid #ccc; padding: 10px; background: #f9f9f9 !important; border-radius: 4px; white-space: pre-wrap; word-wrap: break-word; font-size: 10pt; }
        #pdf-stage code { font-family: monospace; background: #eee !important; padding: 2px 4px; }
        #pdf-stage blockquote { border-left: 4px solid #000; padding-left: 15px; color: #555 !important; font-style: italic; margin: 15px 0; }
        #pdf-stage img { max-width: 100%; }
        #pdf-stage table { width: 100%; border-collapse: collapse; border: 1px solid #000; margin: 15px 0; }
        #pdf-stage th, #pdf-stage td { border: 1px solid #000; padding: 8px; }
        
        .pdf-header-mark { text-align: center; font-size: 16pt; font-weight: bold; color: #333 !important; border-bottom: 2px solid #8b5e3c; padding-bottom: 15px; margin-bottom: 40px; }
        .pdf-footer-mark { margin-top: 60px; padding-top: 15px; border-top: 1px solid #000; text-align: center; font-size: 10pt; color: #666 !important; font-style: italic; white-space: nowrap; page-break-inside: avoid; }
        .pdf-footer-mark a { color: #666 !important; text-decoration: underline !important; font-weight: bold; }

        #loading-toast { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.8); color: white; padding: 15px 30px; border-radius: 8px; font-size: 16px; z-index: 99999; display: none; }

        /* GitHub é…ç½®å¼¹çª— */
        #settings-modal {
            display:none; position:fixed; top:0; left:0; width:100%; height:100%;
            background:rgba(0,0,0,0.5); z-index:20000; justify-content:center; align-items:center;
        }

        /* é­”æ³•é“¾æ¥æŒ‰é’®æ ·å¼ (æ–°å¢) */
        .btn-magic-link { 
            width: 100%; margin-top: 15px; padding: 10px; 
            background: linear-gradient(135deg, #667eea, #764ba2); color: white; 
            border: none; border-radius: 4px; cursor: pointer; font-weight: bold;
            transition: opacity 0.2s;
        }
        .btn-magic-link:hover { opacity: 0.9; }

        @media (max-width: 768px) {
            .workspace { flex-direction: column; }
            .pane { width: 100%; height: 50%; padding: 0; }
            #editor, #preview { padding: 20px; }
            .header-wrapper { flex-direction: column; gap: 15px; height: auto; }
            .header-right { width: 100%; justify-content: space-between; flex-wrap: wrap; }
            .filename-tag { display: none; }
        }
    </style>
</head>
<body>

    <div id="loading-toast">â³ æ­£åœ¨æ¸²æŸ“ PDF...</div>

    <div id="main-app">
        <div class="header-wrapper">
            <div class="header-left">
                <h1>
                    <img src="/logo.png" alt="Logo" style="height: 32px; vertical-align: middle;">
                    <span>åœ¨çº¿ç¼–è¾‘å™¨</span>
                </h1>
            </div>
            <div class="header-right">
                <span id="filenamePreview" class="filename-tag">æ–°æ–‡æ¡£.md</span>
                
                <button class="btn" style="background:#f0f0f0; color:#333;" onclick="openSettings()">
                    âš™ï¸ è®¾ç½®
                </button>

                <button class="btn btn-cloud" onclick="pushToGitHub()">
                    â˜ï¸ ä¿å­˜å¹¶å‘å¸ƒ
                </button>

                <button id="btnPdf" class="btn btn-pdf" onclick="exportToPDF()">
                    PDF (A4)
                </button>

                <button class="btn btn-primary" onclick="downloadFile()">
                    .md
                </button>
                
                <button class="btn btn-magic" onclick="transferToCard()">
                    é•¿å›¾
                </button>
            </div>
        </div>

        <div class="workspace-container">
            <div class="workspace">
                <div class="pane pane-editor">
                    <textarea id="editor" spellcheck="false"></textarea>
                </div>
                <div id="preview" class="pane markdown-body"></div>
            </div>
        </div>

        <footer></footer>
    </div>

    <div id="pdf-stage"></div>

    <div id="settings-modal" onclick="if(event.target===this) closeSettings()">
        <div style="background:white; padding:30px; border-radius:12px; width:400px; box-shadow:0 10px 30px rgba(0,0,0,0.2);">
            <h3 style="margin-top:0; color:#333;">âš™ï¸ GitHub å‘å¸ƒé…ç½®</h3>
            <p style="font-size:12px; color:#666; margin-bottom:20px;">é…ç½®åå¯å°† .md æ–‡ä»¶æ¨é€åˆ°ä»“åº“çš„ /prompt ç›®å½•ã€‚</p>
            
            <div style="margin-bottom:15px;">
                <label style="display:block; font-size:12px; font-weight:bold; margin-bottom:5px; color:#555;">GitHub ç”¨æˆ·å (Owner)</label>
                <input type="text" id="gh-owner" value="itskys" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:4px;">
            </div>
            <div style="margin-bottom:15px;">
                <label style="display:block; font-size:12px; font-weight:bold; margin-bottom:5px; color:#555;">ä»“åº“å (Repo)</label>
                <input type="text" id="gh-repo" value="kayler" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:4px;">
            </div>
            <div style="margin-bottom:15px;">
                <label style="display:block; font-size:12px; font-weight:bold; margin-bottom:5px; color:#555;">Token (éœ€ repo æƒé™)</label>
                <input type="password" id="gh-token" placeholder="github_pat_..." style="width:100%; padding:8px; border:1px solid #ddd; border-radius:4px;">
            </div>
            <div style="margin-bottom:15px;">
                <label style="display:block; font-size:12px; font-weight:bold; margin-bottom:5px; color:#555;">ä¿å­˜è·¯å¾„</label>
                <input type="text" id="gh-path" value="prompt/" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:4px;">
            </div>

            <div style="text-align:right; margin-top:20px; border-bottom:1px solid #eee; padding-bottom:20px;">
                <button onclick="closeSettings()" style="padding:8px 15px; border:none; background:#eee; cursor:pointer; border-radius:4px; margin-right:10px;">å–æ¶ˆ</button>
                <button onclick="saveSettings()" style="padding:8px 15px; border:none; background:#8b5e3c; color:white; cursor:pointer; border-radius:4px;">ä¿å­˜é…ç½®</button>
            </div>

            <div style="margin-top:20px;">
                <button class="btn-magic-link" onclick="generateMagicLink()">âš¡ ç”Ÿæˆè·¨è®¾å¤‡ç™»å½•é“¾æ¥</button>
                <p style="font-size:12px; color:#999; margin-top:8px;">ç”Ÿæˆçš„é“¾æ¥åŒ…å«æ‚¨çš„å¯†é’¥ï¼Œå‘é€åˆ°æ‰‹æœº/å¹³æ¿æ‰“å¼€å³å¯è‡ªåŠ¨ç™»å½•ã€‚</p>
            </div>
        </div>
    </div>

    <script>
        const editor = document.getElementById('editor');
        const preview = document.getElementById('preview');
        const filenameDisplay = document.getElementById('filenamePreview');
        const btnPdf = document.getElementById('btnPdf');
        const mainApp = document.getElementById('main-app');
        const pdfStage = document.getElementById('pdf-stage');
        const toast = document.getElementById('loading-toast');
        const settingsModal = document.getElementById('settings-modal');

        const markdownGuide = `# Markdown è¯­æ³•é€ŸæŸ¥æŒ‡å—... (è¿™é‡Œçœç•¥ï¼Œä¿æŒåŸæœ‰å†…å®¹)`;

        // ... (checkPlaceholderMode, focus, input, getSmartFilename, updateFilenamePreview ä¿æŒä¸å˜) ...
        function checkPlaceholderMode() {
            if (editor.value === markdownGuide) editor.classList.add('placeholder-mode');
            else editor.classList.remove('placeholder-mode');
        }
        editor.addEventListener('focus', () => { if(editor.value === markdownGuide) editor.classList.remove('placeholder-mode'); });
        editor.addEventListener('input', () => {
            const markdownText = editor.value;
            preview.innerHTML = marked.parse(markdownText);
            checkPlaceholderMode();
            localStorage.setItem('kayler_editor_cache', markdownText);
            updateFilenamePreview(markdownText);
        });
        function getSmartFilename(content, extension = ".md") {
            const match = content.match(/^#\s+(.*)$/m);
            if (match && match[1].trim() !== "") {
                const cleanName = match[1].trim().replace(/[\\/:*?"<>|]/g, "");
                return cleanName + extension;
            }
            return "KaylerEditor" + extension;
        }
        function updateFilenamePreview(content) { filenameDisplay.innerText = getSmartFilename(content, ".md"); }
        function downloadFile() { /* ... */ }
        function transferToCard() { /* ... */ }
        function exportToPDF() { /* ... å¤åˆ¶ v3.4 çš„ exportToPDF é€»è¾‘ */
            let author = prompt("è¯·è¾“å…¥æ‚¨çš„ç½²åï¼ˆç”¨äºé¡µè„šæ°´å°ï¼‰:", "Kaylerris");
            if (author === null) return; 
            if (author.trim() === "") author = "Guest";
            toast.style.display = 'block';
            const headerHTML = `<div class="pdf-header-mark">Kayleråœ¨çº¿ç¼–è¾‘å™¨</div>`;
            const bodyHTML = marked.parse(editor.value);
            const footerHTML = `<div class="pdf-footer-mark">Created by @${author} With <a href="https://x.aisai.cc/" target="_blank">x.aisai.cc</a></div>`;
            pdfStage.innerHTML = headerHTML + bodyHTML + footerHTML;
            mainApp.style.display = 'none'; pdfStage.style.display = 'block';
            document.body.classList.add('export-mode'); window.scrollTo(0, 0);
            const filename = getSmartFilename(editor.value, ".pdf");
            const opt = { margin: 15, filename: filename, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2, useCORS: true, scrollY: 0 }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }, pagebreak: { mode: ['avoid-all', 'css', 'legacy'] } };
            setTimeout(() => { html2pdf().set(opt).from(pdfStage).save().then(() => { document.body.classList.remove('export-mode'); pdfStage.style.display = 'none'; mainApp.style.display = 'flex'; toast.style.display = 'none'; }).catch(err => { console.error(err); alert("å¯¼å‡ºå‡ºé”™ï¼Œè¯·åˆ·æ–°é‡è¯•"); document.body.classList.remove('export-mode'); pdfStage.style.display = 'none'; mainApp.style.display = 'flex'; toast.style.display = 'none'; }); }, 800);
        }

        // === GitHub å‘å¸ƒé€»è¾‘ ===
        function openSettings() {
            if(localStorage.getItem('gh_owner')) document.getElementById('gh-owner').value = localStorage.getItem('gh_owner');
            if(localStorage.getItem('gh_repo')) document.getElementById('gh-repo').value = localStorage.getItem('gh_repo');
            document.getElementById('gh-token').value = localStorage.getItem('gh_token') || '';
            settingsModal.style.display = 'flex';
        }

        function closeSettings() { settingsModal.style.display = 'none'; }

        function saveSettings() {
            localStorage.setItem('gh_owner', document.getElementById('gh-owner').value.trim());
            localStorage.setItem('gh_repo', document.getElementById('gh-repo').value.trim());
            localStorage.setItem('gh_token', document.getElementById('gh-token').value.trim());
            localStorage.setItem('gh_path', document.getElementById('gh-path').value.trim());
            alert('é…ç½®å·²ä¿å­˜ï¼');
            closeSettings();
        }

        // === æ ¸å¿ƒæ–°å¢ï¼šç”Ÿæˆ Magic Link ===
        function generateMagicLink() {
            const owner = document.getElementById('gh-owner').value.trim();
            const repo = document.getElementById('gh-repo').value.trim();
            const token = document.getElementById('gh-token').value.trim();

            if (!owner || !repo || !token) {
                alert("è¯·å…ˆå¡«å†™å¹¶ä¿å­˜å®Œæ•´çš„é…ç½®ä¿¡æ¯ï¼ˆTokenä¸èƒ½ä¸ºç©ºï¼‰ï¼");
                return;
            }

            const config = { o: owner, r: repo, t: token };
            const encoded = btoa(JSON.stringify(config));
            const magicUrl = `${window.location.origin}/editor.html?gh_key=${encoded}`;
            
            navigator.clipboard.writeText(magicUrl).then(() => {
                alert("ğŸ”— é­”æ³•é“¾æ¥å·²å¤åˆ¶ï¼\n\næ‚¨å¯ä»¥å°†æ­¤é“¾æ¥å‘é€åˆ°ä»»æ„è®¾å¤‡ï¼Œæ‰“å¼€å³å¯è‡ªåŠ¨ç™»å½•ç®¡ç†å‘˜è´¦å·ã€‚\n(è¯·æ³¨æ„ä¿æŠ¤æ­¤é“¾æ¥ï¼Œå®ƒåŒ…å«æ‚¨çš„å¯†é’¥)");
            });
        }

        async function pushToGitHub() { /* ... (ä¿æŒä¸å˜) ... */ 
            const owner = localStorage.getItem('gh_owner');
            const repo = localStorage.getItem('gh_repo');
            const token = localStorage.getItem('gh_token');
            let pathPrefix = localStorage.getItem('gh_path') || 'prompt/';
            if (!pathPrefix.endsWith('/')) pathPrefix += '/';
            if (!token) { alert('è¯·å…ˆç‚¹å‡»â€œâš™ï¸ è®¾ç½®â€å¹¶è¾“å…¥æ‚¨çš„ Tokenï¼'); openSettings(); return; }
            const content = editor.value;
            if (!content.trim()) { alert("å†…å®¹ä¸ºç©ºï¼Œæ— æ³•å‘å¸ƒ"); return; }
            const filename = getSmartFilename(content, ".md");
            const fullPath = (pathPrefix + filename).replace('//', '/');
            const btn = event.currentTarget; const originalText = btn.innerHTML;
            btn.innerHTML = "â³ ä¸Šä¼ ä¸­..."; btn.disabled = true; toast.innerText = "â˜ï¸ æ­£åœ¨æ¨é€åˆ° GitHub..."; toast.style.display = 'block';
            try {
                let sha = null;
                const checkUrl = `https://api.github.com/repos/${owner}/${repo}/contents/${fullPath}`;
                const checkRes = await fetch(checkUrl, { headers: { 'Authorization': `token ${token}`, 'Accept': 'application/vnd.github.v3+json' } });
                if (checkRes.ok) { const data = await checkRes.json(); sha = data.sha; if(!confirm(`æ–‡ä»¶ ${fullPath} å·²å­˜åœ¨ï¼Œæ˜¯å¦è¦†ç›–ï¼Ÿ`)) { throw new Error("ç”¨æˆ·å–æ¶ˆä¸Šä¼ "); } } else if (checkRes.status !== 404) { const errText = await checkRes.text(); throw new Error(`GitHub API Error (${checkRes.status}): ${errText}`); }
                const contentEncoded = btoa(unescape(encodeURIComponent(content)));
                const payload = { message: `Update ${filename} via Kayler Editor`, content: contentEncoded, branch: "main" };
                if (sha) payload.sha = sha;
                const putRes = await fetch(checkUrl, { method: 'PUT', headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (putRes.ok) { alert(`âœ… å‘å¸ƒæˆåŠŸï¼\næ–‡ä»¶å·²æ¨é€åˆ° GitHub: ${fullPath}\nCloudflare Pages å°†åœ¨å‡ åˆ†é’Ÿå†…è‡ªåŠ¨æ„å»ºä¸Šçº¿ã€‚`); } else { const errData = await putRes.json(); throw new Error(`Upload Failed: ${errData.message}`); }
            } catch (err) { console.error(err); if (err.message !== "ç”¨æˆ·å–æ¶ˆä¸Šä¼ ") { alert(`âŒ å‘å¸ƒå¤±è´¥:\n${err.message}`); } } finally { btn.innerHTML = originalText; btn.disabled = false; toast.style.display = 'none'; }
        }

        const cached = localStorage.getItem('kayler_editor_cache');
        if (cached && cached.length > 5) {
            editor.value = cached;
            editor.classList.remove('placeholder-mode');
        } else {
            editor.value = markdownGuide;
            editor.classList.add('placeholder-mode');
        }
        editor.dispatchEvent(new Event('input')); 
    </script>

</body>
</html>