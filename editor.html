<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta property="og:image" content="https://x.aisai.cc/social-cover.png">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="layout.js"></script>
    <title>在线 Markdown 编辑器 - Kayler</title>
    <link rel="icon" href="/favicon.png" type="image/png">
    
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <style>
        :root { 
            --brand-brown: #8b5e3c; 
            --brand-brown-hover: #6d4c41;
            --bg-body: #f2f4f7;
            --layout-width: 94%;
            --layout-max-width: 1600px;
        }
        * { box-sizing: border-box; }
        
        /* === 布局基础 === */
        html, body {
            margin: 0; padding: 0;
            height: 100%; 
            font-family: "PingFang SC", "Microsoft YaHei", sans-serif;
            background: var(--bg-body); color: #333;
        }
        
        /* 平时：禁止滚动，应用 Flex 布局 */
        body { overflow: hidden; display: flex; flex-direction: column; }

        /* 导出模式：允许滚动 (PDF生成用) */
        body.export-mode {
            overflow: visible !important;
            height: auto !important;
            background: white !important;
            display: block !important;
        }

        /* === 主应用容器 === */
        #main-app {
            display: flex; flex-direction: column; height: 100%; width: 100%;
        }

        /* 顶部导航 */
        .top-nav {
            background: white; border-bottom: 1px solid #eee; 
            height: 40px; flex-shrink: 0; 
            display: flex; justify-content: center; z-index: 20;
        }
        .top-nav-inner {
            width: var(--layout-width); max-width: var(--layout-max-width);
            display: flex; justify-content: flex-end; align-items: center; gap: 20px;
        }
        .top-nav a {
            text-decoration: none; color: #666; font-size: 14px; font-weight: 600;
            display: flex; align-items: center; gap: 5px; transition: 0.2s;
        }
        .top-nav a:hover { color: var(--brand-brown); }

        /* 头部工具栏 */
        .header-wrapper {
            flex-shrink: 0; 
            width: var(--layout-width); max-width: var(--layout-max-width); 
            margin: 15px auto; 
            background: white; padding: 12px 20px; border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.03);
            display: flex; justify-content: space-between; align-items: center;
        }

        .header-left h1 { 
            font-size: 20px; margin: 0; font-weight: 800; color: #222; 
            display: flex; align-items: center; gap: 10px;
        }

        .header-right { display: flex; gap: 10px; align-items: center; }

        .filename-tag {
            font-size: 13px; color: #888; background: #f5f5f5; 
            padding: 6px 12px; border-radius: 6px; font-family: monospace; border: 1px solid #eee;
        }

        .btn {
            padding: 8px 15px; border-radius: 6px; border: none; cursor: pointer; font-size: 13px; font-weight: bold;
            display: flex; align-items: center; gap: 5px; transition: all 0.2s;
        }
        .btn-primary { background: #333; color: white; }
        .btn-pdf { background: #d32f2f; color: white; }
        .btn-magic { background: var(--brand-brown); color: white; }
        .btn-cloud { background: #2e7d32; color: white; } /* 绿色云同步按钮 */
        .btn:hover { opacity: 0.9; transform: translateY(-1px); }

        /* === 主工作区 === */
        .workspace-container {
            flex: 1; width: 100%; display: flex; justify-content: center;
            overflow: hidden; padding-bottom: 10px;
        }

        .workspace { 
            width: var(--layout-width); max-width: var(--layout-max-width);
            height: 100%; display: flex; 
            background: white; border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.05); 
            overflow: hidden; border: 1px solid #e0e0e0;
        }
        
        /* 分栏容器 */
        .pane { 
            width: 50%; height: 100%; 
            position: relative;
        }

        /* 左侧编辑器 (CSS 修复版：独立滚动) */
        .pane-editor { overflow: hidden; padding: 0; }
        
        #editor {
            width: 100%; height: 100%; 
            border: none; border-right: 1px solid #eee;
            resize: none; outline: none; 
            font-family: "Menlo", "Monaco", monospace;
            font-size: 15px; line-height: 1.7; 
            padding: 30px; 
            color: #333; background: white; display: block; 
            overflow-y: auto; /* 关键：内部滚动 */
            box-sizing: border-box;
        }
        #editor.placeholder-mode { color: #aaa; }

        /* 右侧预览区 */
        #preview { 
            background: #fdfbf7; color: #333; padding: 30px 40px; 
            overflow-y: auto; 
        }
        
        /* Markdown 渲染样式 */
        .markdown-body h1 { border-bottom: 2px solid #e0e0e0; padding-bottom: 10px; font-size: 26px; margin-top: 0; color: #000; }
        .markdown-body h2 { border-bottom: 1px solid #e0e0e0; padding-bottom: 8px; font-size: 20px; margin-top: 25px; color: #333; }
        .markdown-body blockquote { border-left: 4px solid var(--brand-brown); padding-left: 15px; color: #666; background: rgba(139, 94, 60, 0.05); padding: 10px; margin: 15px 0; }
        .markdown-body code { background: #eee; padding: 2px 5px; border-radius: 4px; font-family: monospace; color: #c7254e; font-size: 0.9em; }
        .markdown-body pre { background: #282c34; color: #abb2bf; padding: 15px; border-radius: 8px; overflow-x: auto; }
        .markdown-body pre code { color: inherit; background: transparent; padding: 0; }
        .markdown-body img { max-width: 100%; border-radius: 6px; }
        .markdown-body table { width: 100%; border-collapse: collapse; margin: 15px 0; }
        .markdown-body th, .markdown-body td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        .markdown-body th { background: #f0f0f0; font-weight: bold; }

        footer {
            height: 40px; background: white; border-top: 1px solid #ddd;
            display: flex; justify-content: center; align-items: center;
            font-size: 12px; color: #999; flex-shrink: 0;
        }

        /* === PDF 专用舞台 (平时隐藏) === */
        #pdf-stage {
            display: none; 
            width: 100%; 
            margin: 0;
            background: white !important; 
            padding: 0; 
            color: black;
            font-family: "SimSun", "Times New Roman", serif;
        }
        
        #pdf-stage * { color: black !important; background-color: transparent !important; }
        
        #pdf-stage p, #pdf-stage pre, #pdf-stage blockquote, #pdf-stage ul, #pdf-stage ol, #pdf-stage table, #pdf-stage h1, #pdf-stage h2, #pdf-stage h3 {
            page-break-inside: avoid; break-inside: avoid;
        }

        #pdf-stage h1 { font-size: 24pt; border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 20px; }
        #pdf-stage h2 { font-size: 18pt; border-bottom: 1px solid #ccc; margin-top: 30px; page-break-after: avoid; }
        #pdf-stage p { font-size: 12pt; line-height: 1.6; margin-bottom: 10px; text-align: justify; }
        #pdf-stage pre { border: 1px solid #ccc; padding: 10px; background: #f9f9f9 !important; border-radius: 4px; white-space: pre-wrap; word-wrap: break-word; font-size: 10pt; }
        #pdf-stage code { font-family: monospace; background: #eee !important; padding: 2px 4px; }
        #pdf-stage blockquote { border-left: 4px solid #000; padding-left: 15px; color: #555 !important; font-style: italic; margin: 15px 0; }
        #pdf-stage img { max-width: 100%; }
        #pdf-stage table { width: 100%; border-collapse: collapse; border: 1px solid #000; margin: 15px 0; }
        #pdf-stage th, #pdf-stage td { border: 1px solid #000; padding: 8px; }
        
        .pdf-header-mark {
            text-align: center; font-size: 16pt; font-weight: bold; color: #333 !important;
            border-bottom: 2px solid #8b5e3c; padding-bottom: 15px; margin-bottom: 40px;
        }
        
        .pdf-footer-mark {
            margin-top: 60px; padding-top: 15px; border-top: 1px solid #000;
            text-align: center; 
            font-size: 10pt; color: #666 !important; font-style: italic;
            white-space: nowrap; 
            page-break-inside: avoid;
        }
        .pdf-footer-mark a {
            color: #666 !important; 
            text-decoration: underline !important; 
            font-weight: bold;
        }

        /* 加载遮罩 */
        #loading-toast {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.8); color: white; padding: 15px 30px;
            border-radius: 8px; font-size: 16px; z-index: 99999; display: none;
        }

        /* === GitHub 设置弹窗 === */
        #settings-modal {
            display:none; position:fixed; top:0; left:0; width:100%; height:100%;
            background:rgba(0,0,0,0.5); z-index:20000; justify-content:center; align-items:center;
        }

        @media (max-width: 768px) {
            .workspace { flex-direction: column; }
            .pane { width: 100%; height: 50%; padding: 0; }
            #editor, #preview { padding: 20px; }
            .header-wrapper { flex-direction: column; gap: 15px; height: auto; }
            .header-right { width: 100%; justify-content: space-between; flex-wrap: wrap; }
            .filename-tag { display: none; }
        }
    </style>
</head>
<body>

    <div id="loading-toast">⏳ 处理中...</div>

    <div id="main-app">


        <div class="header-wrapper">
            <div class="header-left">
                <h1>
                    <img src="/logo.png" alt="Logo" style="height: 32px; vertical-align: middle;">
                    <span>在线编辑器</span>
                </h1>
            </div>
            <div class="header-right">
                <span id="filenamePreview" class="filename-tag">新文档.md</span>
                
                <button class="btn" style="background:#f0f0f0; color:#333;" onclick="openSettings()">
                    ⚙️ 设置
                </button>

                <button class="btn btn-cloud" onclick="pushToGitHub()">
                    ☁️ 保存并发布
                </button>

                <button id="btnPdf" class="btn btn-pdf" onclick="exportToPDF()">
                    PDF (A4)
                </button>

                <button class="btn btn-primary" onclick="downloadFile()">
                    .md
                </button>
                
                <button class="btn btn-magic" onclick="transferToCard()">
                    长图
                </button>
            </div>
        </div>

        <div class="workspace-container">
            <div class="workspace">
                <div class="pane pane-editor">
                    <textarea id="editor" spellcheck="false"></textarea>
                </div>
                <div id="preview" class="pane markdown-body"></div>
            </div>
        </div>


    </div>

    <div id="pdf-stage"></div>

    <div id="settings-modal" onclick="if(event.target===this) closeSettings()">
        <div style="background:white; padding:30px; border-radius:12px; width:400px; box-shadow:0 10px 30px rgba(0,0,0,0.2);">
            <h3 style="margin-top:0; color:#333;">⚙️ GitHub 发布配置</h3>
            <p style="font-size:12px; color:#666; margin-bottom:20px;">配置后可将 .md 文件推送到仓库的 /prompt 目录。</p>
            
            <div style="margin-bottom:15px;">
                <label style="display:block; font-size:12px; font-weight:bold; margin-bottom:5px; color:#555;">GitHub 用户名 (Owner)</label>
                <input type="text" id="gh-owner" value="itskys" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:4px;">
            </div>
            
            <div style="margin-bottom:15px;">
                <label style="display:block; font-size:12px; font-weight:bold; margin-bottom:5px; color:#555;">仓库名 (Repo)</label>
                <input type="text" id="gh-repo" value="kayler" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:4px;">
            </div>

            <div style="margin-bottom:15px;">
                <label style="display:block; font-size:12px; font-weight:bold; margin-bottom:5px; color:#555;">Token (请在此处粘贴)</label>
                <input type="password" id="gh-token" placeholder="github_pat_..." style="width:100%; padding:8px; border:1px solid #ddd; border-radius:4px;">
            </div>

            <div style="margin-bottom:15px;">
                <label style="display:block; font-size:12px; font-weight:bold; margin-bottom:5px; color:#555;">保存路径</label>
                <input type="text" id="gh-path" value="prompt/" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:4px;">
            </div>

            <div style="text-align:right; margin-top:20px;">
                <button onclick="closeSettings()" style="padding:8px 15px; border:none; background:#eee; cursor:pointer; border-radius:4px; margin-right:10px;">取消</button>
                <button onclick="saveSettings()" style="padding:8px 15px; border:none; background:#8b5e3c; color:white; cursor:pointer; border-radius:4px;">保存配置</button>
            </div>
        </div>
    </div>

    <script>
        const editor = document.getElementById('editor');
        const preview = document.getElementById('preview');
        const filenameDisplay = document.getElementById('filenamePreview');
        const btnPdf = document.getElementById('btnPdf');
        const mainApp = document.getElementById('main-app');
        const pdfStage = document.getElementById('pdf-stage');
        const toast = document.getElementById('loading-toast');
        const settingsModal = document.getElementById('settings-modal');

        const markdownGuide = `# Markdown 语法速查指南

## 1. 标题语法
# 一级标题
## 二级标题
### 三级标题

## 2. 文本样式
**这是加粗文字**
*这是斜体文字*
~~这是删除线~~

## 3. 引用与列表
> 这是一个引用块，适合放金句或备注。

- 无序列表项 1
- 无序列表项 2
  - 缩进子列表

1. 有序列表项 1
2. 有序列表项 2

## 4. 代码与分割线
行内代码： \`print("Hello World")\`

代码块：
\`\`\`javascript
function sayHello() {
  console.log("Hello form Kayler Editor!");
}
\`\`\`

---

## 5. 链接与图片
[点击跳转到 Kayler 首页](index.html)

![示例图片](https://placehold.co/600x200/8b5e3c/FFF?text=Image+Example)

## 6. 表格
| 序号 | 名称 | 版本 |
| :--- | :--- | :--- |
| 01 | Kayler Card | v1.0 |
| 02 | Editor | v4.2 |
`;

        function checkPlaceholderMode() {
            if (editor.value === markdownGuide) editor.classList.add('placeholder-mode');
            else editor.classList.remove('placeholder-mode');
        }

        editor.addEventListener('focus', () => {
            if(editor.value === markdownGuide) editor.classList.remove('placeholder-mode');
        });

        editor.addEventListener('input', () => {
            const markdownText = editor.value;
            preview.innerHTML = marked.parse(markdownText);
            checkPlaceholderMode();
            localStorage.setItem('kayler_editor_cache', markdownText);
            updateFilenamePreview(markdownText);
        });

        function getSmartFilename(content, extension = ".md") {
            const match = content.match(/^#\s+(.*)$/m);
            if (match && match[1].trim() !== "") {
                const cleanName = match[1].trim().replace(/[\\/:*?"<>|]/g, "");
                return cleanName + extension;
            }
            return "KaylerEditor" + extension;
        }

        function updateFilenamePreview(content) {
            filenameDisplay.innerText = getSmartFilename(content, ".md");
        }

        function downloadFile() {
            const content = editor.value;
            if (!content.trim()) { alert("内容为空，无法导出"); return; }
            const filename = getSmartFilename(content, ".md");
            const blob = new Blob([content], { type: "text/markdown" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = filename;
            document.body.appendChild(a); a.click();
            document.body.removeChild(a); URL.revokeObjectURL(url);
        }

        function transferToCard() {
            const cleanText = preview.innerText;
            if(!cleanText.trim()) { alert('预览区为空'); return; }
            localStorage.setItem('kayler_draft', cleanText);
            window.location.href = 'index.html';
        }

        function exportToPDF() {
            let author = prompt("请输入您的署名（用于页脚水印）:", "Kaylerris");
            if (author === null) return; 
            if (author.trim() === "") author = "Guest";

            toast.innerText = "⏳ 正在渲染 PDF...";
            toast.style.display = 'block';

            const headerHTML = `<div class="pdf-header-mark">Kayler在线编辑器</div>`;
            const bodyHTML = marked.parse(editor.value);
            const footerHTML = `
                <div class="pdf-footer-mark">
                    Created by @${author} With <a href="https://x.aisai.cc/" target="_blank">x.aisai.cc</a>
                </div>
            `;
            pdfStage.innerHTML = headerHTML + bodyHTML + footerHTML;

            mainApp.style.display = 'none';
            pdfStage.style.display = 'block';
            
            document.body.classList.add('export-mode');
            window.scrollTo(0, 0);

            const filename = getSmartFilename(editor.value, ".pdf");
            
            const opt = {
                margin:       15, 
                filename:     filename,
                image:        { type: 'jpeg', quality: 0.98 },
                html2canvas:  { 
                    scale: 2, 
                    useCORS: true, 
                    scrollY: 0 
                }, 
                jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' },
                pagebreak:    { mode: ['avoid-all', 'css', 'legacy'] }
            };

            setTimeout(() => {
                html2pdf().set(opt).from(pdfStage).save().then(() => {
                    document.body.classList.remove('export-mode');
                    pdfStage.style.display = 'none';
                    mainApp.style.display = 'flex';
                    toast.style.display = 'none';
                }).catch(err => {
                    console.error(err);
                    alert("导出出错，请刷新重试");
                    document.body.classList.remove('export-mode');
                    pdfStage.style.display = 'none';
                    mainApp.style.display = 'flex';
                    toast.style.display = 'none';
                });
            }, 800);
        }

        // === GitHub 发布逻辑 ===
        function openSettings() {
            if(localStorage.getItem('gh_owner')) document.getElementById('gh-owner').value = localStorage.getItem('gh_owner');
            if(localStorage.getItem('gh_repo')) document.getElementById('gh-repo').value = localStorage.getItem('gh_repo');
            document.getElementById('gh-token').value = localStorage.getItem('gh_token') || '';
            settingsModal.style.display = 'flex';
        }

        function closeSettings() { settingsModal.style.display = 'none'; }

        function saveSettings() {
            localStorage.setItem('gh_owner', document.getElementById('gh-owner').value.trim());
            localStorage.setItem('gh_repo', document.getElementById('gh-repo').value.trim());
            localStorage.setItem('gh_token', document.getElementById('gh-token').value.trim());
            localStorage.setItem('gh_path', document.getElementById('gh-path').value.trim());
            alert('配置已保存到本地浏览器！');
            closeSettings();
        }

        async function pushToGitHub() {
            const owner = localStorage.getItem('gh_owner') || document.getElementById('gh-owner').value;
            const repo = localStorage.getItem('gh_repo') || document.getElementById('gh-repo').value;
            const token = localStorage.getItem('gh_token');
            let pathPrefix = localStorage.getItem('gh_path') || 'prompt/';
            if (!pathPrefix.endsWith('/')) pathPrefix += '/';
            
            if (!token) {
                alert('请先点击“⚙️ 设置”并输入您的 Token！');
                openSettings();
                return;
            }

            const content = editor.value;
            if (!content.trim()) { alert("内容为空，无法发布"); return; }
            
            const filename = getSmartFilename(content, ".md");
            const fullPath = (pathPrefix + filename).replace('//', '/');

            const btn = event.currentTarget;
            const originalText = btn.innerHTML;
            btn.innerHTML = "⏳ 上传中...";
            btn.disabled = true;
            toast.innerText = "☁️ 正在推送到 GitHub...";
            toast.style.display = 'block';

            try {
                // 1. Check file existence
                let sha = null;
                const checkUrl = `https://api.github.com/repos/${owner}/${repo}/contents/${fullPath}`;
                
                const checkRes = await fetch(checkUrl, {
                    headers: { 
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (checkRes.ok) {
                    const data = await checkRes.json();
                    sha = data.sha;
                    if(!confirm(`文件 ${fullPath} 已存在，是否覆盖？`)) {
                        throw new Error("用户取消上传");
                    }
                } else if (checkRes.status !== 404) {
                    const errText = await checkRes.text();
                    throw new Error(`GitHub API Error (${checkRes.status}): ${errText}`);
                }

                // 2. Upload
                const contentEncoded = btoa(unescape(encodeURIComponent(content)));
                
                const payload = {
                    message: `Update ${filename} via Kayler Editor`,
                    content: contentEncoded,
                    branch: "main" // 默认为 main
                };
                if (sha) payload.sha = sha;

                const putRes = await fetch(checkUrl, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                if (putRes.ok) {
                    alert(`✅ 发布成功！\n文件已推送到: ${fullPath}\n请等待 Cloudflare 自动构建。`);
                } else {
                    const errData = await putRes.json();
                    throw new Error(`Upload Failed: ${errData.message}`);
                }

            } catch (err) {
                console.error(err);
                if (err.message !== "用户取消上传") {
                    alert(`❌ 发布失败:\n${err.message}`);
                }
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
                toast.style.display = 'none';
            }
        }

        const cached = localStorage.getItem('kayler_editor_cache');
        if (cached && cached.length > 5) {
            editor.value = cached;
            editor.classList.remove('placeholder-mode');
        } else {
            editor.value = markdownGuide;
            editor.classList.add('placeholder-mode');
        }
        editor.dispatchEvent(new Event('input')); 
    </script>

</body>
</html>