<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta property="og:image" content="https://x.aisai.cc/social-cover.png">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æç¤ºè¯ç®¡ç†å™¨ - Kayler</title>
    <link rel="icon" href="/favicon.png" type="image/png">
    
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="layout.js?v=5.1"></script>
    
    <style>
        /* === å…¨å±€å˜é‡ === */
        :root {
            --bg-body: #f2f4f7; --text-color: #2c2c2c;
            --brand-brown: #8b5e3c; --brand-brown-hover: #6d4c41;
            --card-shadow: 0 4px 20px rgba(0,0,0,0.05);
            --layout-width: 94%; --layout-max-width: 1600px;
        }
        * { box-sizing: border-box; }
        body {
            font-family: "PingFang SC", "Microsoft YaHei", sans-serif;
            background-color: var(--bg-body); margin: 0; padding: 20px;
            display: flex; flex-direction: column; align-items: center;
            min-height: 100vh; color: var(--text-color);
        }

        /* é¡¶éƒ¨å¯¼èˆªç”± layout.js æ³¨å…¥ */
        header { text-align: center; margin-bottom: 30px; margin-top: 10px; }
        h1 { font-size: 28px; font-weight: 800; color: #333; display: flex; align-items: center; justify-content: center; margin: 0; }
        
        /* === å¸ƒå±€å®¹å™¨ (Grid) === */
        .main-container {
            width: var(--layout-width); max-width: var(--layout-max-width);
            display: grid; grid-template-columns: 380px 1fr; gap: 30px;
            align-items: start; flex: 1;
        }

        /* é€šç”¨å¡ç‰‡ */
        .card { background: white; border-radius: 12px; box-shadow: var(--card-shadow); overflow: hidden; display: flex; flex-direction: column; }
        .card-header { 
            padding: 15px 20px; border-bottom: 1px solid #eee; background: #fafafa;
            display: flex; justify-content: space-between; align-items: center; font-weight: bold; color: #555;
        }

        /* === å·¦ä¾§ï¼šæ’°å†™åŠ©æ‰‹ (v12.0 å‡çº§ç‰ˆ) === */
        .builder-body { padding: 20px; }
        #promptInput {
            width: 100%; height: 200px; border: 1px solid #ddd; border-radius: 8px;
            resize: vertical; outline: none; padding: 15px; 
            font-family: "Menlo", monospace; font-size: 13px; line-height: 1.6;
            background: #fdfdfd; color: #333; margin-bottom: 15px;
        }
        #promptInput:focus { background: #fff; border-color: var(--brand-brown); }

        /* åˆ†ç±»æ ‡ç­¾æ  */
        .tags-category { margin-bottom: 15px; }
        .cat-title { font-size: 12px; color: #999; margin-bottom: 6px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; }
        .tags-list { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 15px; }
        .tag {
            background: #f0f0f0; padding: 4px 10px; border-radius: 4px;
            font-size: 12px; cursor: pointer; color: #555; transition: 0.2s;
            border: 1px solid transparent; user-select: none;
        }
        .tag:hover { border-color: var(--brand-brown); color: var(--brand-brown); background: white; }
        .tag.param { background: #e3f2fd; color: #1565c0; }
        .tag.style { background: #f3e5f5; color: #7b1fa2; }

        .builder-actions { display: flex; gap: 8px; flex-wrap: wrap; }
        .btn { flex: 1; padding: 8px; border-radius: 6px; border: none; cursor: pointer; font-size: 12px; font-weight: bold; transition: 0.2s; white-space: nowrap; }
        .btn-primary { background: var(--brand-brown); color: white; }
        .btn-secondary { background: #eee; color: #555; }
        .btn:hover { opacity: 0.9; }

        /* === å³ä¾§ï¼šçŸ¥è¯†åº“åˆ—è¡¨ === */
        .toolbar { padding: 15px 20px; display: flex; gap: 15px; align-items: center; border-bottom: 1px solid #eee; background: white; }
        .search-box { flex: 1; position: relative; display: flex; align-items: center; }
        .search-input {
            width: 100%; padding: 8px 12px 8px 35px; border: 1px solid #ddd; border-radius: 6px;
            font-size: 14px; outline: none; transition: 0.2s;
        }
        .search-input:focus { border-color: var(--brand-brown); box-shadow: 0 0 0 2px rgba(139, 94, 60, 0.1); }
        .search-icon { position: absolute; left: 10px; color: #999; font-size: 14px; }
        
        .status-badge { font-size: 12px; padding: 4px 8px; border-radius: 4px; background: #e8f5e9; color: #2e7d32; display: none; }
        .status-badge.show { display: inline-block; }

        /* ç®¡ç†å‘˜çŠ¶æ€æŒ‰é’® */
        .admin-status-btn {
            font-size: 12px; padding: 6px 12px; border-radius: 20px; cursor: pointer; border: 1px solid #ddd;
            display: flex; align-items: center; gap: 5px; transition: 0.2s; background: white; color: #666;
        }
        .admin-status-btn.active { background: #e8f5e9; color: #2e7d32; border-color: #c8e6c9; font-weight: bold; }
        .admin-status-btn:hover { opacity: 0.8; }

        table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        thead { background: #f9f7f1; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #eee; font-size: 13px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        
        th.sortable { cursor: pointer; user-select: none; }
        th.sortable:hover { background: #f0ebe4; }
        th.sortable::after { content: ' â†•'; font-size: 10px; color: #ccc; margin-left: 4px; }
        th.sortable.asc::after { content: ' â†‘'; color: var(--brand-brown); }
        th.sortable.desc::after { content: ' â†“'; color: var(--brand-brown); }
        
        th { font-weight: 600; color: #8b5e3c; }
        tr:hover { background-color: #fafafa; }

        .file-link { color: #333; font-weight: 600; cursor: pointer; text-decoration: none; border-bottom: 1px dashed #ccc; }
        .file-link:hover { color: var(--brand-brown); border-color: var(--brand-brown); }
        .example-link { color: #1565c0; cursor: pointer; margin-right: 8px; font-size: 12px; }
        .example-link:hover { text-decoration: underline; }
        
        .badge { display: inline-block; padding: 2px 6px; border-radius: 4px; font-size: 11px; background: #eee; color: #555; }
        .badge.ver { background: #e8f5e9; color: #2e7d32; font-weight: bold; }
        .badge.cat { background: #fff3e0; color: #e65100; border: 1px solid #ffe0b2; }

        /* === å¼¹çª—é€šç”¨ === */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; justify-content: center; align-items: center; backdrop-filter: blur(2px); }
        .modal-overlay.active { display: flex; }
        .modal-content { background: white; width: 800px; max-width: 90%; height: 80vh; border-radius: 12px; display: flex; flex-direction: column; box-shadow: 0 20px 50px rgba(0,0,0,0.2); position: relative; }
        .modal-header { padding: 15px 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; background: #fafafa; }
        .modal-body { flex: 1; padding: 20px; overflow-y: auto; background: #fff; font-family: monospace; font-size: 13px; line-height: 1.5; white-space: pre-wrap; word-break: break-all; }
        .modal-footer { padding: 15px; border-top: 1px solid #eee; display: flex; justify-content: flex-end; gap: 10px; background: #fff; }
        
        /* åˆ é™¤æŒ‰é’® (v12.0) */
        .btn-delete-file { 
            background: #ffebee; color: #c62828; border: 1px solid #ffcdd2; display: none; 
        }
        .btn-delete-file:hover { background: #c62828; color: white; }

        /* é¢„è§ˆ Markdown */
        .markdown-body h1 { border-bottom: 2px solid #eee; padding-bottom: 10px; font-size: 24px; }
        .markdown-body pre { background: #f5f5f5; padding: 15px; border-radius: 8px; overflow-x: auto; }

        /* æç®€é…ç½®å¼¹çª— */
        .config-box { background: white; width: 400px; padding: 25px; border-radius: 12px; display: flex; flex-direction: column; gap: 15px; }
        .config-title { font-size: 18px; margin: 0; }
        .config-row { display: flex; flex-direction: column; gap: 5px; }
        .config-label { font-size: 12px; font-weight: bold; color: #666; }
        .config-input { padding: 8px; border: 1px solid #ddd; border-radius: 4px; }

        /* ç¯ç®± */
        #lightbox { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 3000; justify-content: center; align-items: center; flex-direction: column; }
        #lightbox.active { display: flex; }
        #lightbox img, #lightbox video { max-width: 95%; max-height: 85vh; border-radius: 4px; box-shadow: 0 0 30px black; }
        .lightbox-close { position: absolute; top: 20px; right: 30px; font-size: 40px; color: white; cursor: pointer; transition: 0.2s; }
        .lightbox-close:hover { color: var(--brand-brown); }

        /* å“åº”å¼ */
        @media (max-width: 1024px) {
            .main-container { grid-template-columns: 1fr; }
            .builder-area { order: 1; } 
        }
        @media (max-width: 768px) {
            th:nth-child(2), td:nth-child(2), /* ç‰ˆæœ¬ */
            th:nth-child(3), td:nth-child(3), /* åˆ†ç±» */
            th:nth-child(6), td:nth-child(6)  /* ä½œè€… */
            { display: none; }
            th:nth-child(1) { width: 40%; } /* åç§° */
            th:nth-child(4) { width: 30%; } /* æè¿° */
            th:nth-child(5) { width: 30%; } /* ç¤ºä¾‹ */
        }
    </style>
</head>
<body>

    <header>
        <h1><img src="/logo.png" style="height:32px; margin-right:10px;">æç¤ºè¯ç®¡ç†å™¨</h1>
    </header>

    <div class="main-container">
        
        <div class="card builder-area">
            <div class="card-header">
                <span>ğŸ¨ æ’°å†™åŠ©æ‰‹</span>
                <span style="font-size:12px; cursor:pointer; color:#888;" onclick="clearPrompt()">æ¸…ç©º</span>
            </div>
            <div class="builder-body">
                <textarea id="promptInput" placeholder="è¾“å…¥æˆ–ç‚¹å‡»ä¸‹æ–¹æ ‡ç­¾..."></textarea>
                
                <div class="tags-wrapper">
                    <div class="tags-category">
                        <div class="cat-title">âœ¨ å¸¸ç”¨å‚æ•°</div>
                        <div class="tags-list">
                            <div class="tag param" onclick="addTag('--ar 16:9')">16:9</div>
                            <div class="tag param" onclick="addTag('--ar 9:16')">9:16</div>
                            <div class="tag param" onclick="addTag('--v 6.0')">V6.0</div>
                            <div class="tag param" onclick="addTag('--niji 6')">Niji 6</div>
                            <div class="tag param" onclick="addTag('--stylize 250')">é£æ ¼åŒ– 250</div>
                        </div>
                    </div>
                    
                    <div class="tags-category">
                        <div class="cat-title">ğŸ¨ é£æ ¼/ç”»è´¨</div>
                        <div class="tags-list" id="styleTagsList">
                            </div>
                    </div>

                    <div class="tags-category">
                        <div class="cat-title">ğŸ·ï¸ è‡ªå®šä¹‰</div>
                        <div class="tags-list" id="customTagsList"></div>
                        <button class="btn btn-secondary" style="width:100%" onclick="addNewTag()">+ æ·»åŠ è‡ªå®šä¹‰æ ‡ç­¾</button>
                    </div>
                </div>

                <div class="builder-actions">
                    <button class="btn btn-secondary" onclick="openPreview()">ğŸ‘ï¸ é¢„è§ˆ</button>
                    <button class="btn btn-primary" onclick="copyPrompt()">ğŸ“‹ å¤åˆ¶</button>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <span>ğŸ“š æç¤ºè¯åº“</span>
                <div style="display:flex; gap:10px; align-items:center;">
                    <div id="adminStatusBtn" class="admin-status-btn" onclick="openLocalSettings()">
                        âš™ï¸ é…ç½® (æœªç™»å½•)
                    </div>
                    
                    <span id="cacheStatus" class="status-badge">âš¡ ç¼“å­˜</span>
                    <button class="refresh-btn" onclick="forceRefresh()" style="border:none; background:none; cursor:pointer;">ğŸ”„</button>
                </div>
            </div>
            
            <div class="toolbar">
                <div class="search-box">
                    <span class="search-icon">ğŸ”</span>
                    <input type="text" id="searchInput" class="search-input" placeholder="æœç´¢åç§°ã€æè¿°æˆ–åˆ†ç±»..." oninput="filterFiles()">
                </div>
            </div>

            <div class="list-container">
                <div id="loadingState" style="padding:40px; text-align:center; display:none; color:#999;">
                    <div>â³ è¯»å–ä¸­...</div>
                </div>
                <table id="dataTable">
                    <thead>
                        <tr>
                            <th style="width:25%;" class="sortable" onclick="sortTable('displayName')" data-key="displayName">åç§°</th>
                            <th style="width:10%;" class="sortable" onclick="sortTable('version')" data-key="version">ç‰ˆæœ¬</th>
                            <th style="width:10%;" class="sortable" onclick="sortTable('category')" data-key="category">åˆ†ç±»</th>
                            <th style="width:25%;">åŠŸèƒ½æè¿°</th>
                            <th style="width:20%;">ç¤ºä¾‹ (è‡ªåŠ¨)</th>
                            <th style="width:10%;" class="sortable" onclick="sortTable('author')" data-key="author">ä½œè€…</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="modalOverlay" onclick="if(event.target===this) closeModal()">
        <div class="modal-content">
            <div class="modal-header">
                <b id="modalTitle">æ–‡ä»¶é¢„è§ˆ</b>
                <span class="close-btn" onclick="closeModal()" style="cursor:pointer; font-size:20px;">Ã—</span>
            </div>
            <div class="modal-body" id="fileContent">åŠ è½½ä¸­...</div>
            <div class="modal-footer">
                <button class="btn btn-delete-file" id="btnDelete" onclick="deleteCurrentFile()">ğŸ—‘ï¸ åˆ é™¤æ–‡ä»¶</button>
                
                <button class="btn btn-secondary" onclick="downloadFile()">ğŸ“¥ ä¸‹è½½ .md</button>
                <button class="btn btn-primary" id="btnImport" style="display:none;" onclick="importToEditor()">âœï¸ å¯¼å…¥ç¼–è¾‘å™¨</button>
                <button class="btn btn-primary" onclick="copyContent()">ğŸ“‹ å¤åˆ¶</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="settingsModal" onclick="if(event.target===this) closeLocalSettings()">
        <div class="config-box">
            <h3 class="config-title">âš™ï¸ å…¨å±€é…ç½®</h3>
            <div class="config-row">
                <span class="config-label">GitHub Token <span style="color:red">*</span></span>
                <input type="password" id="confToken" class="config-input" placeholder="ghp_xxxxxxxxxxxx">
            </div>
            <div class="config-row">
                <span class="config-label">ç”¨æˆ·å (Owner)</span>
                <input type="text" id="confOwner" class="config-input" placeholder="itskys">
            </div>
            <div class="config-row">
                <span class="config-label">ä»“åº“å (Repo)</span>
                <input type="text" id="confRepo" class="config-input" placeholder="kayler">
            </div>
            <div style="text-align:right; margin-top:10px;">
                <button class="btn btn-secondary" onclick="closeLocalSettings()">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="saveLocalSettings()">ğŸ’¾ ä¿å­˜</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="previewModal" onclick="if(event.target===this) document.getElementById('previewModal').classList.remove('active')">
        <div class="modal-content">
             <div class="modal-header"><b>Markdown é¢„è§ˆ</b><span class="close-btn" onclick="document.getElementById('previewModal').classList.remove('active')" style="cursor:pointer; font-size:20px;">Ã—</span></div>
            <div class="modal-body markdown-body" id="previewBody"></div>
        </div>
    </div>

    <div id="lightbox" onclick="if(event.target===this) closeLightbox()">
        <span class="lightbox-close" onclick="closeLightbox()">&times;</span>
        <img id="lbImg" style="display:none;">
        <video id="lbVideo" controls style="display:none;"></video>
    </div>

    <script>
        // === é…ç½®ä¸çŠ¶æ€ ===
        const CONFIG = { owner: 'itskys', repo: 'kayler', path: 'prompt', branch: 'main' };
        const CACHE_KEY = 'prompt_list_v9'; 
        const CACHE_DURATION = 5 * 60 * 1000;

        let allFiles = [];      
        let displayFiles = [];  
        let currentSort = { key: 'displayName', order: 'asc' };
        let currentFile = { name: '', content: '', sha: '' }; // v12.0: å¢åŠ SHA
        
        const defaultStyleTags = ['Cyberpunk', 'Ukiyo-e', '8k resolution', 'Masterpiece', 'Studio Ghibli', 'Realistic'];
        let userTags = JSON.parse(localStorage.getItem('kayler_user_tags') || '[]');

        // === åˆå§‹åŒ– ===
        document.addEventListener('DOMContentLoaded', () => {
            renderTags();
            checkAdminStatus();
            loadData();
        });

        // === 1. ç®¡ç†å‘˜é€»è¾‘ (v12.0) ===
        function checkAdminStatus() {
            const btn = document.getElementById('adminStatusBtn');
            const token = localStorage.getItem('gh_token');
            if(token) {
                btn.classList.add('active');
                btn.innerHTML = 'ğŸŸ¢ ç®¡ç†å‘˜ (å·²é…ç½®)';
            } else {
                btn.classList.remove('active');
                btn.innerHTML = 'âš™ï¸ é…ç½® (æœªç™»å½•)';
            }
        }

        function openLocalSettings() {
            document.getElementById('confToken').value = localStorage.getItem('gh_token') || '';
            document.getElementById('confOwner').value = localStorage.getItem('gh_owner') || 'itskys';
            document.getElementById('confRepo').value = localStorage.getItem('gh_repo') || 'kayler';
            document.getElementById('settingsModal').classList.add('active');
        }
        function closeLocalSettings() { document.getElementById('settingsModal').classList.remove('active'); }
        function saveLocalSettings() {
            localStorage.setItem('gh_token', document.getElementById('confToken').value.trim());
            localStorage.setItem('gh_owner', document.getElementById('confOwner').value.trim());
            localStorage.setItem('gh_repo', document.getElementById('confRepo').value.trim());
            closeLocalSettings();
            checkAdminStatus();
            forceRefresh(); // é…ç½®å˜æ›´åå¼ºåˆ¶åˆ·æ–°
        }

        // === 2. æ•°æ®è·å– ===
        async function loadData(force = false) {
            const loading = document.getElementById('loadingState');
            const table = document.getElementById('dataTable');
            const cacheBadge = document.getElementById('cacheStatus');
            
            loading.style.display = 'block';
            table.style.display = 'none';
            if(cacheBadge) cacheBadge.classList.remove('show');

            if (!force) {
                const cached = localStorage.getItem(CACHE_KEY);
                if (cached) {
                    try {
                        const data = JSON.parse(cached);
                        if (Date.now() - data.ts < CACHE_DURATION && Array.isArray(data.files)) {
                            allFiles = data.files;
                            finishLoad(true);
                            return;
                        }
                    } catch(e) {}
                }
            }

            const owner = localStorage.getItem('gh_owner') || CONFIG.owner;
            const repo = localStorage.getItem('gh_repo') || CONFIG.repo;
            const token = localStorage.getItem('gh_token');
            const headers = token ? { 'Authorization': `token ${token}` } : {};

            try {
                // Fetch Prompt
                const promptUrl = `https://api.github.com/repos/${owner}/${repo}/contents/${CONFIG.path}?ref=${CONFIG.branch}&t=${Date.now()}`;
                const pRes = await fetch(promptUrl, { headers });
                
                if (!pRes.ok) {
                    if (pRes.status === 403) throw new Error("APIé™æµæˆ–Tokenæ— æ•ˆ");
                    if (pRes.status === 404) throw new Error("æ‰¾ä¸åˆ° prompt ç›®å½•");
                    throw new Error(`API Error: ${pRes.status}`);
                }
                const pFiles = await pRes.json();
                
                // Fetch Gallery (Async)
                let gFiles = [];
                try {
                    const galleryUrl = `https://api.github.com/repos/${owner}/${repo}/contents/gallery?ref=${CONFIG.branch}&t=${Date.now()}`;
                    const gRes = await fetch(galleryUrl, { headers });
                    if(gRes.ok) gFiles = await gRes.json();
                } catch(e) {}

                // Process Data
                allFiles = pFiles
                    .filter(f => f.name && (f.name.endsWith('.md') || f.name.endsWith('.txt')))
                    .map(f => {
                        const meta = parseFilenameV8(f.name);
                        const examples = gFiles.filter(img => {
                            if (!img.name) return false;
                            const imgNameLower = img.name.toLowerCase();
                            const promptKey = meta.pureName.toLowerCase().replace(/[^a-z0-9\u4e00-\u9fa5]/g, "");
                            const imgCore = imgNameLower.replace(/^\d{14}_/, '').replace(/[^a-z0-9\u4e00-\u9fa5]/g, "");
                            
                            if (!imgCore.includes(promptKey)) return false;

                            // Version Check
                            const currentVer = meta.version.replace(/[vV]/, ''); 
                            const imgVerMatch = imgNameLower.match(/(?:v|ver|_v)(\d+(?:\.\d+)?)/i);
                            if (imgVerMatch) {
                                return Math.floor(parseFloat(imgVerMatch[1])) === Math.floor(parseFloat(currentVer));
                            }
                            return true;
                        }).map(img => ({
                            name: img.name,
                            url: img.download_url || img.url,
                            type: img.name.endsWith('.mp4') ? 'video' : 'image'
                        }));

                        return { ...meta, rawName: f.name, sha: f.sha, examples };
                    });

                localStorage.setItem(CACHE_KEY, JSON.stringify({ ts: Date.now(), files: allFiles }));
                finishLoad(false);

            } catch (e) {
                loading.innerHTML = `<span style="color:red">âš ï¸ ${e.message}</span>`;
            }
        }

        function finishLoad(isCached) {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('dataTable').style.display = 'table';
            if(isCached && document.getElementById('cacheStatus')) document.getElementById('cacheStatus').classList.add('show');
            filterFiles();
        }

        function forceRefresh() { loadData(true); }

        function parseFilenameV8(filename) {
            const clean = filename.replace(/\.(md|txt)$/i, '');
            const parts = clean.split('_');
            let category = 'Base', name = clean, version = '-', desc = '-';
            const verIndex = parts.findIndex(p => /^v\d+(\.\d+)?$/i.test(p));

            if (verIndex > -1) {
                version = parts[verIndex];
                const preVer = parts.slice(0, verIndex);
                if (preVer.length >= 2) { category = preVer[0]; name = preVer.slice(1).join(' '); }
                else if (preVer.length === 1) { name = preVer[0]; }
                const postVer = parts.slice(verIndex + 1);
                if (postVer.length > 0) desc = postVer.join(' ');
            } else if (parts.length >= 2) { category = parts[0]; name = parts.slice(1).join(' '); }

            return { pureName: name, displayName: name, category, version, desc, author: 'Kaylerris' };
        }

        // === æœç´¢ä¸æ’åº ===
        function filterFiles() {
            const q = document.getElementById('searchInput').value.toLowerCase();
            displayFiles = allFiles.filter(f => 
                (f.displayName && f.displayName.toLowerCase().includes(q)) || 
                (f.category && f.category.toLowerCase().includes(q)) ||
                (f.desc && f.desc.toLowerCase().includes(q))
            );
            applySort();
        }

        function sortTable(key) {
            if (currentSort.key === key) currentSort.order = currentSort.order === 'asc' ? 'desc' : 'asc';
            else { currentSort.key = key; currentSort.order = 'asc'; }
            applySort();
        }

        function applySort() {
            document.querySelectorAll('th.sortable').forEach(th => {
                th.classList.remove('asc', 'desc');
                if (th.dataset.key === currentSort.key) th.classList.add(currentSort.order);
            });
            displayFiles.sort((a, b) => {
                let va = (a[currentSort.key] || '').toLowerCase();
                let vb = (b[currentSort.key] || '').toLowerCase();
                if (va < vb) return currentSort.order === 'asc' ? -1 : 1;
                if (va > vb) return currentSort.order === 'asc' ? 1 : -1;
                return 0;
            });
            renderTable();
        }

        function renderTable() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';
            if(displayFiles.length === 0) { tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:#999;padding:20px;">æš‚æ— æ•°æ®</td></tr>'; return; }

            displayFiles.forEach(item => {
                let exHtml = '<span style="color:#ccc">-</span>';
                if (item.examples && item.examples.length) {
                    exHtml = item.examples.slice(0, 2).map((ex, i) => 
                        `<a class="example-link" onclick="openLightbox('${ex.url}','${ex.type}')">${ex.type==='video'?'ğŸ¬':'ğŸ–¼ï¸'} ç¤ºä¾‹${i+1}</a>`
                    ).join('');
                }
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><a class="file-link" onclick="viewFile('${item.rawName}', '${item.displayName}', '${item.sha}')">${item.displayName}</a></td>
                    <td><span class="badge ver">${item.version}</span></td>
                    <td><span class="badge cat">${item.category}</span></td>
                    <td style="color:#666; font-size:12px;">${item.desc}</td>
                    <td>${exHtml}</td>
                    <td>${item.author}</td>`;
                tbody.appendChild(tr);
            });
        }

        // === æ’°å†™åŠ©æ‰‹ (v12.0) ===
        function renderTags() {
            const styleContainer = document.getElementById('styleTagsList');
            const customContainer = document.getElementById('customTagsList');
            
            styleContainer.innerHTML = defaultStyleTags.map(t => `<div class="tag style" onclick="addTag('${t}')">${t}</div>`).join('');
            customContainer.innerHTML = userTags.map(t => `<div class="tag" onclick="addTag('${t}')">${t}</div>`).join('');
        }
        function addTag(txt) {
            const el = document.getElementById('promptInput');
            el.value += (el.value ? ' ' : '') + txt;
        }
        function addNewTag() {
            const newTag = prompt("æ–°æ ‡ç­¾:");
            if (newTag && !userTags.includes(newTag)) {
                userTags.push(newTag);
                localStorage.setItem('kayler_user_tags', JSON.stringify(userTags));
                renderTags();
            }
        }
        function clearPrompt() { if(confirm('æ¸…ç©ºï¼Ÿ')) document.getElementById('promptInput').value = ''; }
        function copyPrompt() { navigator.clipboard.writeText(document.getElementById('promptInput').value).then(()=>alert('å·²å¤åˆ¶')); }
        function openPreview() {
            const txt = document.getElementById('promptInput').value;
            if(!txt.trim()) return;
            document.getElementById('previewBody').innerHTML = marked.parse(txt);
            document.getElementById('previewModal').classList.add('active');
        }

        // === æ–‡ä»¶æ“ä½œ ===
        function viewFile(filename, display, sha) {
            document.getElementById('modalTitle').innerText = display;
            document.getElementById('fileContent').innerText = "â³ è¯»å–ä¸­...";
            document.getElementById('modalOverlay').classList.add('active');
            
            const btnImport = document.getElementById('btnImport');
            const btnDelete = document.getElementById('btnDelete');
            
            // æƒé™æ£€æŸ¥
            const token = localStorage.getItem('gh_token');
            if(token) {
                btnImport.style.display = 'inline-block'; btnImport.disabled = true; btnImport.style.opacity = '0.5';
                btnDelete.style.display = 'inline-block'; // æ˜¾ç¤ºåˆ é™¤æŒ‰é’®
            } else {
                btnImport.style.display = 'none';
                btnDelete.style.display = 'none';
            }

            const owner = localStorage.getItem('gh_owner') || CONFIG.owner;
            const repo = localStorage.getItem('gh_repo') || CONFIG.repo;
            const url = `https://raw.githubusercontent.com/${owner}/${repo}/${CONFIG.branch}/${CONFIG.path}/${encodeURIComponent(filename)}`;

            fetch(url).then(r=>{if(!r.ok)throw new Error();return r.text()})
                .then(text => {
                    document.getElementById('fileContent').innerText = text;
                    currentFile = { name: filename, content: text, sha: sha };
                    if(token) { btnImport.disabled = false; btnImport.style.opacity = '1'; }
                })
                .catch(()=>{
                    document.getElementById('fileContent').innerText = "âŒ è¯»å–å¤±è´¥ï¼Œè¯·æ£€æŸ¥Tokenæˆ–ç½‘ç»œ";
                });
        }

        // === åˆ é™¤åŠŸèƒ½ (v12.0) ===
        async function deleteCurrentFile() {
            if(!confirm(`âš ï¸ è­¦å‘Šï¼šç¡®å®šè¦æ°¸ä¹…åˆ é™¤ "${currentFile.name}" å—ï¼Ÿ`)) return;
            
            const token = localStorage.getItem('gh_token');
            const owner = localStorage.getItem('gh_owner') || CONFIG.owner;
            const repo = localStorage.getItem('gh_repo') || CONFIG.repo;
            const btn = document.getElementById('btnDelete');
            
            btn.innerText = "â³..."; btn.disabled = true;

            try {
                const url = `https://api.github.com/repos/${owner}/${repo}/contents/${CONFIG.path}/${encodeURIComponent(currentFile.name)}`;
                const res = await fetch(url, {
                    method: 'DELETE',
                    headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: `Delete prompt: ${currentFile.name}`, sha: currentFile.sha, branch: 'main' })
                });

                if(res.ok) {
                    alert("âœ… åˆ é™¤æˆåŠŸï¼");
                    closeModal();
                    forceRefresh();
                } else { throw new Error((await res.json()).message); }
            } catch(e) { alert("âŒ åˆ é™¤å¤±è´¥: " + e.message); }
            
            btn.innerText = "ğŸ—‘ï¸ åˆ é™¤æ–‡ä»¶"; btn.disabled = false;
        }

        function importToEditor() {
            if(!currentFile.content) return;
            localStorage.setItem('kayler_editor_cache', currentFile.content);
            localStorage.setItem('kayler_editor_filename', currentFile.name);
            window.location.href = 'editor.html';
        }

        function downloadFile() {
            if(!currentFile.content) return;
            const blob = new Blob([currentFile.content], {type:'text/markdown'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = currentFile.name; a.click();
        }

        function openLightbox(url, type) {
            const lb = document.getElementById('lightbox');
            const img = document.getElementById('lbImg');
            const vid = document.getElementById('lbVideo');
            lb.classList.add('active');
            if(type==='video') { img.style.display='none'; vid.style.display='block'; vid.src=url; }
            else { vid.style.display='none'; img.style.display='block'; img.src=url; }
        }
        function closeLightbox() { document.getElementById('lightbox').classList.remove('active'); document.getElementById('lbVideo').pause(); }
        function closeModal() { document.getElementById('modalOverlay').classList.remove('active'); }
        function copyContent() { navigator.clipboard.writeText(document.getElementById('fileContent').innerText).then(()=>alert('å·²å¤åˆ¶')); }
    </script>
</body>
</html>