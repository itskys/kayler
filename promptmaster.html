<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta property="og:image" content="https://x.aisai.cc/social-cover.png">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æç¤ºè¯ç®¡ç†å™¨ - Kayler</title>
    <link rel="icon" href="/favicon.png" type="image/png">
    
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <style>
        /* === å…¨å±€å˜é‡ === */
        :root {
            --bg-body: #f2f4f7; --text-color: #2c2c2c;
            --brand-brown: #8b5e3c; --brand-brown-hover: #6d4c41;
            --card-shadow: 0 4px 20px rgba(0,0,0,0.05);
        }

        * { box-sizing: border-box; }

        body {
            font-family: "PingFang SC", "Microsoft YaHei", sans-serif;
            background-color: var(--bg-body); margin: 0; padding: 20px;
            display: flex; flex-direction: column; align-items: center;
            min-height: 100vh; color: var(--text-color);
        }

        /* é¡¶éƒ¨å¯¼èˆª */
        .top-nav {
            width: 100%; max-width: 1200px; display: flex; justify-content: flex-end;
            gap: 25px; margin-bottom: 40px; padding: 0 10px;
        }
        .top-nav a {
            text-decoration: none; color: #555; font-size: 18px; font-weight: 600;
            transition: color 0.2s; display: flex; align-items: center; gap: 5px;
        }
        .top-nav a:hover, .top-nav a.active { color: var(--brand-brown); }

        header { text-align: center; margin-bottom: 40px; }
        h1 { 
            font-size: 32px; font-weight: 800; color: #222; margin-bottom: 10px; 
            display: flex; align-items: center; justify-content: center;
        }
        
        /* === ä¸»å¸ƒå±€å®¹å™¨ === */
        .main-container {
            width: 100%; max-width: 1200px; /* åŠ å®½ä»¥å®¹çº³åŒæ ç¼–è¾‘å™¨ */
            display: flex; flex-direction: column; gap: 40px;
            flex: 1; 
        }

        .section-title {
            font-size: 20px; font-weight: bold; color: #444; border-left: 5px solid var(--brand-brown);
            padding-left: 15px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;
        }
        .refresh-btn {
            font-size: 14px; color: var(--brand-brown); cursor: pointer; text-decoration: none; border: 1px solid var(--brand-brown);
            padding: 4px 10px; border-radius: 4px; transition: all 0.2s; background: transparent;
        }
        .refresh-btn:hover { background: var(--brand-brown); color: white; }

        /* === åŒºåŸŸ 1: å‡çº§ç‰ˆç¼–è¾‘å™¨ (Builder) === */
        .builder-area {
            background: white; padding: 25px; border-radius: 16px;
            box-shadow: var(--card-shadow);
            display: flex; flex-direction: column; gap: 15px;
        }

        /* æ–‡ä»¶åè¾“å…¥è¡Œ */
        .meta-row { display: flex; gap: 15px; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 15px; }
        .filename-input {
            flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; outline: none;
        }
        .filename-input:focus { border-color: var(--brand-brown); }

        /* ç¼–è¾‘å™¨åˆ†æ  */
        .editor-split {
            display: flex; gap: 0; border: 1px solid #eee; border-radius: 8px; overflow: hidden; height: 300px;
        }
        
        .editor-pane {
            width: 50%; height: 100%; padding: 0; position: relative;
        }
        
        /* è¾“å…¥æ¡† */
        #promptInput {
            width: 100%; height: 100%; border: none; border-right: 1px solid #eee;
            resize: none; outline: none; padding: 20px; 
            font-family: "Menlo", monospace; font-size: 14px; line-height: 1.6;
            background: #fafafa; color: #333;
        }
        #promptInput:focus { background: #fff; }

        /* é¢„è§ˆæ¡† */
        #promptPreview {
            width: 50%; height: 100%; overflow-y: auto; padding: 20px;
            background: #fff; color: #333;
        }
        /* Markdown ç®€å•æ ·å¼ */
        #promptPreview h1, #promptPreview h2 { border-bottom: 1px solid #eee; padding-bottom: 5px; margin-top: 0; }
        #promptPreview code { background: #f5f5f5; padding: 2px 4px; border-radius: 3px; color: #c7254e; }
        #promptPreview pre { background: #f5f5f5; padding: 10px; border-radius: 4px; overflow-x: auto; }

        /* æŒ‰é’®ç»„ */
        .builder-actions {
            display: flex; justify-content: space-between; align-items: center; margin-top: 10px;
        }
        .left-actions { display: flex; gap: 10px; }
        .right-actions { display: flex; gap: 10px; }

        .btn {
            padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer;
            font-size: 14px; font-weight: bold; transition: all 0.2s; display: flex; align-items: center; gap: 6px;
        }
        .btn-primary { background: var(--brand-brown); color: white; }
        .btn-secondary { background: #f0f0f0; color: #666; }
        
        /* ç®¡ç†å‘˜æŒ‰é’®æ ·å¼ */
        .btn-admin { background: #ccc; color: white; cursor: not-allowed; }
        .btn-admin.active { background: #2e7d32; cursor: pointer; } /* æ¿€æ´»æ€ç»¿è‰² */
        .btn-admin.active:hover { background: #1b5e20; }

        /* æ ‡ç­¾åº“ */
        .library-area { margin-top: 10px; padding-top: 20px; border-top: 1px dashed #eee; }
        .category-group h3 { font-size: 14px; color: #888; margin: 0 0 10px 0; }
        .tags-container { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 15px; }
        .tag {
            background: white; padding: 6px 12px; border-radius: 50px;
            border: 1px solid #eee; color: #555; cursor: pointer;
            font-size: 12px; transition: all 0.2s; user-select: none;
        }
        .tag:hover {
            border-color: var(--brand-brown); color: var(--brand-brown);
            transform: translateY(-2px); box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        /* === åŒºåŸŸ 2: çŸ¥è¯†åº“åˆ—è¡¨ === */
        .list-container {
            background: white; border-radius: 16px;
            box-shadow: var(--card-shadow); overflow: hidden;
            padding: 0; min-height: 200px;
        }

        table { width: 100%; border-collapse: collapse; }
        thead { background: #f9f7f1; }
        th, td { padding: 15px 20px; text-align: left; border-bottom: 1px solid #eee; font-size: 14px; }
        th { font-weight: bold; color: #8b5e3c; }
        tr:last-child td { border-bottom: none; }
        tr:hover { background-color: #fafafa; }

        .prompt-link {
            color: #2c2c2c; font-weight: 600; text-decoration: none;
            cursor: pointer; transition: color 0.2s; display: inline-flex; align-items: center; gap: 5px;
        }
        .prompt-link:hover { color: var(--brand-brown); text-decoration: underline; }
        .badge {
            display: inline-block; padding: 2px 8px; border-radius: 4px;
            font-size: 12px; font-weight: bold; background: #e0e0e0; color: #555;
        }
        .badge.v-new { background: #e8f5e9; color: #2e7d32; }

        .loading-state {
            display: flex; justify-content: center; align-items: center; height: 200px; color: #999; flex-direction: column; gap: 10px;
        }

        /* === å¼¹çª— === */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 1000;
            justify-content: center; align-items: center;
            backdrop-filter: blur(2px);
        }
        .modal-overlay.active { display: flex; }
        .modal-content {
            background: white; width: 90%; max-width: 800px; height: 80vh;
            border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            display: flex; flex-direction: column; overflow: hidden;
            animation: slideUp 0.3s ease;
        }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .modal-header { padding: 15px 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; background: #fdfbf7; }
        .modal-title { font-size: 18px; font-weight: bold; color: #333; }
        .close-btn { background: none; border: none; font-size: 24px; cursor: pointer; color: #999; }
        .modal-body { flex: 1; padding: 0; overflow-y: auto; background: #fafafa; }
        pre { white-space: pre-wrap; word-wrap: break-word; font-family: "Menlo", monospace; font-size: 14px; padding: 20px; margin: 0; color: #333; }
        .modal-footer { padding: 15px; border-top: 1px solid #eee; text-align: right; background: white; }
        .copy-btn { padding: 8px 16px; background: var(--brand-brown); color: white; border: none; border-radius: 6px; cursor: pointer; }

        footer { margin-top: 60px; padding-top: 20px; border-top: 1px solid #eee; width: 100%; max-width: 1000px; text-align: center; color: #999; font-size: 13px; }

        @media (max-width: 768px) {
            .editor-split { flex-direction: column; height: auto; }
            .editor-pane { width: 100%; height: 200px; }
            #promptPreview { border-top: 1px solid #eee; }
            .builder-actions { flex-direction: column; gap: 10px; }
            .left-actions, .right-actions { width: 100%; justify-content: space-between; }
            th:nth-child(4), td:nth-child(4) { display: none; } /* æ‰‹æœºéšè—ä½œè€…åˆ— */
        }
    </style>
</head>
<body>

    <nav class="top-nav">
        <a href="index.html">ğŸ  å¡ç‰‡ç”Ÿæˆå™¨</a>
        <a href="editor.html" target="_blank" style="color: #2e7d32;">ğŸ“ åœ¨çº¿ç¼–è¾‘å™¨</a>
        <a href="promptmaster.html" class="active">ğŸ’¡ æç¤ºè¯ç®¡ç†å™¨</a>
        <a href="aiGallery.html">ğŸ–¼ï¸ AIå›¾ç‰‡å±•</a>
        <a href="contact.html">ğŸ“© è”ç³»åšä¸»</a>
    </nav>

    <header>
        <h1>
            <img src="/logo.png" alt="Logo" style="height: 36px; vertical-align: middle; margin-right: 8px;">
            æç¤ºè¯ç®¡ç†å™¨
        </h1>
        <p style="color:#888">æ’°å†™ã€ç»„è£…ã€ç®¡ç†æ‚¨çš„ AI æç¤ºè¯èµ„äº§</p>
    </header>

    <div class="main-container">
        
        <div>
            <div class="section-title">
                <span>ğŸ¨ æç¤ºè¯æ’°å†™åŠ©æ‰‹</span>
                <button class="refresh-btn" onclick="openSettings()">âš™ï¸ ç®¡ç†å‘˜é…ç½®</button>
            </div>
            
            <div class="builder-area">
                <div class="meta-row">
                    <span style="font-size:14px; font-weight:bold; color:#666;">æ–‡ä»¶å:</span>
                    <input type="text" id="filenameInput" class="filename-input" placeholder="ä¾‹å¦‚: æ¦‚å¿µæ‹†è§£_v3.2_æ–°ç‰ˆ.md (å»ºè®®æ ¼å¼: åç§°_ç‰ˆæœ¬_æè¿°.md)">
                </div>

                <div class="editor-split">
                    <div class="editor-pane">
                        <textarea id="promptInput" placeholder="# åœ¨æ­¤è¾“å…¥æç¤ºè¯å†…å®¹...&#10;- æ”¯æŒ Markdown æ ¼å¼&#10;- ç‚¹å‡»ä¸‹æ–¹æ ‡ç­¾å¯å¿«é€Ÿæ’å…¥"></textarea>
                    </div>
                    <div class="editor-pane">
                        <div id="promptPreview"></div>
                    </div>
                </div>

                <div class="builder-actions">
                    <div class="left-actions">
                        <button class="btn btn-secondary" onclick="clearPrompt()">ğŸ—‘ï¸ æ¸…ç©º</button>
                        <button class="btn btn-secondary" onclick="downloadLocal()">ğŸ’¾ å­˜åˆ°æœ¬åœ°</button>
                    </div>
                    <div class="right-actions">
                        <button class="btn btn-primary" onclick="copyPrompt()">ğŸ“‹ å¤åˆ¶å†…å®¹</button>
                        <button id="btnPublish" class="btn btn-admin" onclick="pushToGitHub()" disabled title="éœ€éªŒè¯ç®¡ç†å‘˜æƒé™">
                            â˜ï¸ ä¿å­˜å¹¶å‘å¸ƒ
                        </button>
                    </div>
                </div>

                <div class="library-area">
                    <div class="category-group">
                        <h3>å¸¸ç”¨é£æ ¼ & å‚æ•°</h3>
                        <div class="tags-container">
                            <div class="tag" onclick="addTag('Cyberpunk')">èµ›åšæœ‹å…‹</div>
                            <div class="tag" onclick="addTag('Ukiyo-e style')">æµ®ä¸–ç»˜</div>
                            <div class="tag" onclick="addTag('8k resolution')">8K åˆ†è¾¨ç‡</div>
                            <div class="tag" onclick="addTag('--ar 16:9')">å®½å± 16:9</div>
                            <div class="tag" onclick="addTag('--v 6.0')">MJ V6</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div>
            <div class="section-title">
                ğŸ“š æç¤ºè¯çŸ¥è¯†åº“ (è‡ªåŠ¨åŒæ­¥)
                <button class="refresh-btn" onclick="fetchRepoData()">ğŸ”„ åˆ·æ–°åˆ—è¡¨</button>
            </div>
            <div class="list-container">
                <div id="loadingState" class="loading-state">
                    <div style="font-size:24px;">â³</div>
                    <div>æ­£åœ¨ä» GitHub è¯»å–æœ€æ–°åˆ—è¡¨...</div>
                </div>
                <table id="dataTable" style="display:none;">
                    <thead>
                        <tr>
                            <th>æ–‡ä»¶å</th>
                            <th style="width: 80px;">ç‰ˆæœ¬</th>
                            <th>æ™ºèƒ½æè¿°</th>
                            <th style="width: 100px;">ä½œè€…</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
            <p style="text-align:center; color:#999; font-size:12px; margin-top:10px;">
                åˆ—è¡¨æ•°æ®æ¥è‡ª GitHub APIï¼Œå‘å¸ƒæ–°æ–‡ä»¶åéœ€ç­‰å¾… Cloudflare æ„å»º (çº¦1-2åˆ†é’Ÿ)ã€‚
            </p>
        </div>

    </div>

    <footer>
        <p>&copy; 2025 Kaylerris ä¿ç•™æ‰€æœ‰æƒåˆ©.</p>
    </footer>

    <div class="modal-overlay" id="modalOverlay" onclick="if(event.target===this) closeModal()">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="modalTitle">æ–‡ä»¶é¢„è§ˆ</div>
                <button class="close-btn" onclick="closeModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <pre id="fileContent">æ­£åœ¨åŠ è½½...</pre>
            </div>
            <div class="modal-footer">
                <button class="copy-btn" onclick="copyContent()">ğŸ“‹ å¤åˆ¶å…¨éƒ¨å†…å®¹</button>
            </div>
        </div>
    </div>

    <div id="settings-modal" class="modal-overlay" onclick="if(event.target===this) closeSettings()">
        <div style="background:white; padding:30px; border-radius:12px; width:400px; box-shadow:0 10px 30px rgba(0,0,0,0.2);">
            <h3 style="margin-top:0; color:#333;">âš™ï¸ ç®¡ç†å‘˜è®¤è¯</h3>
            <p style="font-size:12px; color:#666; margin-bottom:20px;">é…ç½® GitHub Token ä»¥æ¿€æ´»å‘å¸ƒåŠŸèƒ½ã€‚</p>
            
            <div style="margin-bottom:15px;">
                <label style="display:block; font-size:12px; font-weight:bold; margin-bottom:5px; color:#555;">GitHub ç”¨æˆ·å</label>
                <input type="text" id="gh-owner" value="itskys" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:4px;">
            </div>
            <div style="margin-bottom:15px;">
                <label style="display:block; font-size:12px; font-weight:bold; margin-bottom:5px; color:#555;">ä»“åº“å</label>
                <input type="text" id="gh-repo" value="kayler" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:4px;">
            </div>
            <div style="margin-bottom:15px;">
                <label style="display:block; font-size:12px; font-weight:bold; margin-bottom:5px; color:#555;">Token (éœ€ repo æƒé™)</label>
                <input type="password" id="gh-token" placeholder="github_pat_..." style="width:100%; padding:8px; border:1px solid #ddd; border-radius:4px;">
            </div>

            <div style="text-align:right; margin-top:20px;">
                <button onclick="closeSettings()" style="padding:8px 15px; border:none; background:#eee; cursor:pointer; border-radius:4px; margin-right:10px;">å–æ¶ˆ</button>
                <button onclick="saveSettings()" style="padding:8px 15px; border:none; background:#8b5e3c; color:white; cursor:pointer; border-radius:4px;">ä¿å­˜å¹¶éªŒè¯</button>
            </div>
        </div>
    </div>

    <script>
        // === å¸¸é‡é…ç½® ===
        const promptInput = document.getElementById('promptInput');
        const promptPreview = document.getElementById('promptPreview');
        const filenameInput = document.getElementById('filenameInput');
        const btnPublish = document.getElementById('btnPublish');
        const settingsModal = document.getElementById('settings-modal');
        const tableBody = document.getElementById('tableBody');
        const loadingState = document.getElementById('loadingState');
        const dataTable = document.getElementById('dataTable');

        // é»˜è®¤é…ç½®ï¼ˆç”¨äºè¯»å–åˆ—è¡¨ï¼Œæ— éœ€Tokenï¼‰
        const DEFAULT_CONFIG = {
            owner: 'itskys',
            repo: 'kayler',
            path: 'prompt'
        };

        // === 1. ç¼–è¾‘å™¨é€»è¾‘ ===
        promptInput.addEventListener('input', () => {
            const text = promptInput.value;
            promptPreview.innerHTML = marked.parse(text);
            
            // æ™ºèƒ½è‡ªåŠ¨å¡«å……æ–‡ä»¶å
            if(!filenameInput.value) {
                const match = text.match(/^#\s+(.*)$/m);
                if (match) {
                    const cleanName = match[1].trim().replace(/[\\/:*?"<>|]/g, "");
                    filenameInput.value = cleanName + ".md";
                }
            }
        });

        function addTag(text) {
            let current = promptInput.value;
            if (current.length > 0 && !current.endsWith(' ')) current += ' ';
            promptInput.value = current + text;
            promptInput.dispatchEvent(new Event('input')); // è§¦å‘æ¸²æŸ“
        }

        function clearPrompt() { if(confirm('ç¡®å®šæ¸…ç©ºï¼Ÿ')) promptInput.value = ''; promptPreview.innerHTML = ''; }

        function copyPrompt() {
            navigator.clipboard.writeText(promptInput.value).then(() => alert('å·²å¤åˆ¶!'));
        }

        function downloadLocal() {
            const content = promptInput.value;
            if (!content.trim()) { alert("å†…å®¹ä¸ºç©º"); return; }
            let filename = filenameInput.value || "prompt.md";
            if (!filename.endsWith(".md")) filename += ".md";
            
            const blob = new Blob([content], { type: "text/markdown" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = filename;
            document.body.appendChild(a); a.click();
            document.body.removeChild(a);
        }

        // === 2. æƒé™ç®¡ç† & å‘å¸ƒé€»è¾‘ ===
        
        // æ£€æŸ¥ç®¡ç†å‘˜çŠ¶æ€
        function checkAdminStatus() {
            const token = localStorage.getItem('gh_token');
            if (token) {
                btnPublish.disabled = false;
                btnPublish.classList.add('active');
                btnPublish.innerHTML = "â˜ï¸ ä¿å­˜å¹¶å‘å¸ƒ";
                btnPublish.title = "ç®¡ç†å‘˜å·²è®¤è¯";
            } else {
                btnPublish.disabled = true;
                btnPublish.classList.remove('active');
                btnPublish.innerHTML = "ğŸ”’ éœ€é…ç½®æƒé™";
                btnPublish.title = "è¯·ç‚¹å‡»ä¸Šæ–¹é…ç½®æŒ‰é’®è¾“å…¥ Token";
            }
        }

        function openSettings() {
            // é¢„å¡«æœ¬åœ°ç¼“å­˜
            if(localStorage.getItem('gh_owner')) document.getElementById('gh-owner').value = localStorage.getItem('gh_owner');
            if(localStorage.getItem('gh_repo')) document.getElementById('gh-repo').value = localStorage.getItem('gh_repo');
            document.getElementById('gh-token').value = localStorage.getItem('gh_token') || '';
            settingsModal.style.display = 'flex';
        }

        function closeSettings() { settingsModal.style.display = 'none'; }

        function saveSettings() {
            localStorage.setItem('gh_owner', document.getElementById('gh-owner').value.trim());
            localStorage.setItem('gh_repo', document.getElementById('gh-repo').value.trim());
            localStorage.setItem('gh_token', document.getElementById('gh-token').value.trim());
            alert('é…ç½®å·²ä¿å­˜ï¼');
            checkAdminStatus(); 
            // åˆ·æ–°åˆ—è¡¨ï¼ˆä½¿ç”¨æ–°é…ç½®ï¼‰
            fetchRepoData();
            closeSettings();
        }

        async function pushToGitHub() {
            const owner = localStorage.getItem('gh_owner') || DEFAULT_CONFIG.owner;
            const repo = localStorage.getItem('gh_repo') || DEFAULT_CONFIG.repo;
            const token = localStorage.getItem('gh_token');
            const pathPrefix = 'prompt/';
            
            const content = promptInput.value;
            let filename = filenameInput.value || "untitled.md";
            if (!filename.endsWith(".md")) filename += ".md";
            
            if (!content.trim()) { alert("å†…å®¹ä¸ºç©º"); return; }

            const btn = btnPublish;
            const originalText = btn.innerHTML;
            btn.innerHTML = "â³ å‘å¸ƒä¸­...";
            btn.disabled = true;

            try {
                const fullPath = pathPrefix + filename;
                const checkUrl = `https://api.github.com/repos/${owner}/${repo}/contents/${fullPath}`;
                
                // 1. Check file existence
                let sha = null;
                const checkRes = await fetch(checkUrl, {
                    headers: { 'Authorization': `token ${token}`, 'Accept': 'application/vnd.github.v3+json' }
                });
                if (checkRes.ok) {
                    const data = await checkRes.json();
                    sha = data.sha;
                    if(!confirm(`æ–‡ä»¶ ${filename} å·²å­˜åœ¨ï¼Œè¦†ç›–å—ï¼Ÿ`)) throw new Error("å–æ¶ˆæ“ä½œ");
                }

                // 2. Upload
                const payload = {
                    message: `Update ${filename} via PromptMaster`,
                    content: btoa(unescape(encodeURIComponent(content))),
                    branch: "main"
                };
                if (sha) payload.sha = sha;

                const putRes = await fetch(checkUrl, {
                    method: 'PUT',
                    headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (putRes.ok) {
                    alert(`âœ… å‘å¸ƒæˆåŠŸï¼\næ–‡ä»¶å·²æ¨é€åˆ° GitHubã€‚\nåˆ—è¡¨å°†åœ¨å‡ åˆ†é’Ÿåè‡ªåŠ¨æ›´æ–°ï¼ˆCloudflare æ„å»ºå»¶è¿Ÿï¼‰ã€‚`);
                    // å°è¯•ç«‹å³åˆ·æ–°åˆ—è¡¨ (è™½ç„¶æ˜¯CDNç¼“å­˜ï¼Œä½†å¯èƒ½æœ‰æ–°æ•°æ®)
                    setTimeout(fetchRepoData, 2000); 
                } else {
                    const err = await putRes.json();
                    throw new Error(err.message);
                }

            } catch (e) {
                if(e.message !== "å–æ¶ˆæ“ä½œ") alert("å‘å¸ƒå¤±è´¥: " + e.message);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }


        // === 3. åˆ—è¡¨é€»è¾‘ (è‡ªåŠ¨è¯»å– GitHub) ===
        async function fetchRepoData() {
            loadingState.style.display = 'flex';
            dataTable.style.display = 'none';
            tableBody.innerHTML = '';

            // ä¼˜å…ˆä½¿ç”¨ç”¨æˆ·é…ç½®çš„ repoï¼Œå¦åˆ™ä½¿ç”¨é»˜è®¤
            const owner = localStorage.getItem('gh_owner') || DEFAULT_CONFIG.owner;
            const repo = localStorage.getItem('gh_repo') || DEFAULT_CONFIG.repo;
            // åˆ—è¡¨è¯»å–å¯ä»¥ç”¨ Token (å¦‚æœæœ‰çš„è¯ï¼Œå¯ä»¥æé«˜é™æµ)ï¼Œä¹Ÿå¯ä»¥ä¸ç”¨ (å…¬å¼€ä»“åº“)
            const token = localStorage.getItem('gh_token');
            const headers = token ? { 'Authorization': `token ${token}` } : {};

            try {
                const url = `https://api.github.com/repos/${owner}/${repo}/contents/prompt`;
                const response = await fetch(url, { headers });
                
                if (!response.ok) throw new Error(`æ— æ³•è¯»å–åˆ—è¡¨ (HTTP ${response.status})`);
                
                const files = await response.json();
                
                // è¿‡æ»¤åªæ˜¾ç¤ºæ–‡æœ¬æ–‡ä»¶
                const validFiles = files.filter(f => f.name.endsWith('.md') || f.name.endsWith('.txt'));

                if(validFiles.length === 0) {
                    tableBody.innerHTML = `<tr><td colspan="4" style="text-align:center; color:#999;">æš‚æ— æ–‡ä»¶</td></tr>`;
                } else {
                    validFiles.forEach(file => {
                        const meta = parseFilename(file.name);
                        renderRow(file, meta);
                    });
                }
                
                loadingState.style.display = 'none';
                dataTable.style.display = 'table';

            } catch (error) {
                console.error(error);
                loadingState.innerHTML = `<div style="color:red; text-align:center">âš ï¸ è¯»å–å¤±è´¥<br>${error.message}<br><button class="refresh-btn" onclick="fetchRepoData()" style="margin-top:10px">é‡è¯•</button></div>`;
            }
        }

        // ç®€æ˜“æ–‡ä»¶åè§£æå™¨: "Name_v1.0_Desc.md"
        // ç¤ºä¾‹ï¼šæ¦‚å¿µæ‹†è§£_v3.1_é‡ç‰ˆ.md -> Name:æ¦‚å¿µæ‹†è§£, Ver:v3.1, Desc:é‡ç‰ˆ
        function parseFilename(name) {
            const clean = name.replace(/\.(md|txt)$/, '');
            const parts = clean.split(/[_-]/); // æŒ‰ä¸‹åˆ’çº¿æˆ–çŸ­æ¨ªçº¿åˆ†å‰²
            
            let result = {
                name: parts[0] || clean,
                version: "v1.0",
                desc: "AI æç¤ºè¯æ–‡ä»¶",
                author: "Kaylerris"
            };

            // æ™ºèƒ½è¯†åˆ«ç‰ˆæœ¬å· (vå¼€å¤´+æ•°å­—)
            const verIndex = parts.findIndex(p => /^v\d/.test(p.toLowerCase()));
            if (verIndex !== -1) {
                result.version = parts[verIndex];
                // ç‰ˆæœ¬å·åé¢çš„å†…å®¹ä½œä¸ºæè¿°
                if (verIndex + 1 < parts.length) {
                    result.desc = parts.slice(verIndex + 1).join(' ');
                }
            } else if (parts.length > 1) {
                // å¦‚æœæ²¡æœ‰ç‰ˆæœ¬å·ï¼Œå–ç¬¬äºŒæ®µåšæè¿°
                result.desc = parts.slice(1).join(' ');
            }

            return result;
        }

        function renderRow(file, meta) {
            let badgeClass = meta.version.includes('v3') || meta.version.includes('v2') ? 'badge v-new' : 'badge';
            
            const html = `
                <tr>
                    <td style="font-family:monospace; font-size:13px;">
                        <a class="prompt-link" onclick="viewPrompt('${file.name}', '${meta.name}', '${meta.author}')">
                            ğŸ“„ ${file.name}
                        </a>
                    </td>
                    <td><span class="${badgeClass}">${meta.version}</span></td>
                    <td>${meta.desc}</td>
                    <td>${meta.author}</td>
                </tr>
            `;
            tableBody.insertAdjacentHTML('beforeend', html);
        }

        // === 4. å¼¹çª—é€»è¾‘ ===
        const modal = document.getElementById('modalOverlay');
        const modalTitle = document.getElementById('modalTitle');
        const fileContent = document.getElementById('fileContent');

        function viewPrompt(fileName, displayName, author) {
            modalTitle.innerText = `${displayName} by ${author}`;
            fileContent.innerText = "â³ è¯»å–ä¸­...";
            modal.classList.add('active');

            // ä¼˜å…ˆè¯» GitHub Raw (é¿å… Cloudflare ç¼“å­˜å»¶è¿Ÿ)
            const owner = localStorage.getItem('gh_owner') || DEFAULT_CONFIG.owner;
            const repo = localStorage.getItem('gh_repo') || DEFAULT_CONFIG.repo;
            const rawUrl = `https://raw.githubusercontent.com/${owner}/${repo}/main/prompt/${fileName}`;
            
            // å¤‡ç”¨ï¼šå¦‚æœ Raw å¤±è´¥ï¼ˆæ¯”å¦‚ç§æœ‰ä»“åº“ï¼‰ï¼Œå°è¯•ç”¨ API è¯»å–å†…å®¹ (éœ€ Token)
            // è¿™é‡Œç®€åŒ–é€»è¾‘ï¼šç›´æ¥ fetch Rawï¼Œå¤±è´¥å†æç¤º
            fetch(rawUrl)
                .then(res => {
                    if(!res.ok) throw new Error("Fetch error");
                    return res.text();
                })
                .then(text => fileContent.innerText = text)
                .catch(() => {
                    // å¦‚æœ Raw å¤±è´¥ï¼Œå°è¯•æœ¬åœ°ç›¸å¯¹è·¯å¾„ (Cloudflare Pages)
                    fetch('prompt/' + fileName + '?t=' + new Date().getTime())
                        .then(res => res.text())
                        .then(text => fileContent.innerText = text)
                        .catch(() => fileContent.innerText = "âŒ æ— æ³•è¯»å–æ–‡ä»¶å†…å®¹ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶åæˆ–ç½‘ç»œã€‚");
                });
        }

        function closeModal() { modal.classList.remove('active'); }
        function copyContent() { navigator.clipboard.writeText(fileContent.innerText).then(() => alert('å·²å¤åˆ¶')); }

        // åˆå§‹åŒ–
        checkAdminStatus();
        fetchRepoData();
    </script>

</body>
</html>