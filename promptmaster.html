<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta property="og:image" content="https://x.aisai.cc/social-cover.png">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æç¤ºè¯ç®¡ç†å™¨ - Kayler</title>
    <link rel="icon" href="/favicon.png" type="image/png">
    
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <script src="layout.js"></script>
    
    <style>
        /* === é¡µé¢ç‰¹æœ‰æ ·å¼ === */
        :root {
            --bg-body: #f2f4f7; --text-color: #2c2c2c;
            --brand-brown: #8b5e3c; --card-shadow: 0 4px 20px rgba(0,0,0,0.05);
            --layout-width: 94%; --layout-max-width: 1400px;
        }
        * { box-sizing: border-box; }
        body {
            font-family: "PingFang SC", "Microsoft YaHei", sans-serif;
            background-color: var(--bg-body); margin: 0; padding: 20px;
            display: flex; flex-direction: column; align-items: center;
            min-height: 100vh; color: var(--text-color);
        }

        /* å¸ƒå±€ */
        header { text-align: center; margin-bottom: 40px; margin-top: 20px; }
        h1 { font-size: 32px; font-weight: 800; margin-bottom: 10px; display: flex; align-items: center; justify-content: center; }
        
        .main-container { width: var(--layout-width); max-width: var(--layout-max-width); display: flex; flex-direction: column; gap: 40px; flex: 1; }
        .section-title { font-size: 20px; font-weight: bold; color: #444; border-left: 5px solid var(--brand-brown); padding-left: 15px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        .refresh-btn { font-size: 14px; color: var(--brand-brown); cursor: pointer; border: 1px solid var(--brand-brown); padding: 4px 10px; border-radius: 4px; background: transparent; }
        
        /* ç¼–è¾‘å™¨åŒºåŸŸ */
        .builder-area { background: white; padding: 30px; border-radius: 16px; box-shadow: var(--card-shadow); display: flex; flex-direction: column; gap: 20px; }
        .meta-row { display: flex; gap: 15px; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 20px; }
        .filename-input { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 15px; outline: none; }
        #promptInput { width: 100%; height: 300px; border: 1px solid #eee; border-radius: 8px; resize: vertical; outline: none; padding: 20px; font-family: "Menlo", monospace; font-size: 15px; line-height: 1.7; background: #fafafa; color: #333; }
        
        .builder-actions { display: flex; justify-content: space-between; }
        .left-actions, .right-actions { display: flex; gap: 10px; }
        .btn { padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer; font-size: 14px; font-weight: bold; }
        .btn-primary { background: var(--brand-brown); color: white; }
        .btn-secondary { background: #f0f0f0; color: #666; }
        .btn-preview { background: #e3f2fd; color: #1565c0; }
        
        /* æƒé™æŒ‰é’® */
        .btn-admin { background: #eee; color: #999; cursor: not-allowed; }
        .btn-admin.active { background: #2e7d32; color: white; cursor: pointer; }

        /* æ ‡ç­¾ */
        .library-area { margin-top: 10px; padding-top: 20px; border-top: 1px dashed #eee; }
        .tags-container { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }
        .tag { background: white; padding: 6px 12px; border-radius: 50px; border: 1px solid #eee; cursor: pointer; font-size: 12px; }
        .tag:hover { border-color: var(--brand-brown); color: var(--brand-brown); }

        /* åˆ—è¡¨ */
        .list-container { background: white; border-radius: 16px; box-shadow: var(--card-shadow); overflow: hidden; padding: 0; min-height: 200px; }
        table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        th, td { padding: 18px 20px; text-align: left; border-bottom: 1px solid #eee; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        th { font-weight: bold; color: #8b5e3c; background: #f9f7f1; }
        .prompt-link { color: #2c2c2c; font-weight: 600; text-decoration: none; cursor: pointer; display: flex; align-items: center; gap: 5px; }
        .badge { padding: 2px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; background: #e0e0e0; color: #555; }
        .badge.v-new { background: #e8f5e9; color: #2e7d32; }

        /* å¼¹çª— */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; justify-content: center; align-items: center; }
        .modal-overlay.active { display: flex; }
        .modal-content { background: white; width: 90%; max-width: 900px; height: 85vh; border-radius: 12px; display: flex; flex-direction: column; animation: slideUp 0.3s ease; }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .modal-header { padding: 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; }
        .modal-body { flex: 1; padding: 30px; overflow-y: auto; background: #fff; }
        
        .markdown-body h1 { border-bottom: 2px solid #eee; padding-bottom: 10px; font-size: 24px; }
        .markdown-body pre { background: #f5f5f5; padding: 15px; overflow-x: auto; font-family: monospace; }
        pre.raw-code { font-family: monospace; white-space: pre-wrap; margin: 0; }

        @media (max-width: 768px) {
            .builder-actions { flex-direction: column; gap: 10px; }
            .left-actions, .right-actions { width: 100%; justify-content: space-between; }
            th:nth-child(4), td:nth-child(4) { display: none; }
        }
    </style>
</head>
<body>

    <header>
        <h1>
            <img src="/logo.png" alt="Logo" style="height: 36px; vertical-align: middle; margin-right: 8px;">
            æç¤ºè¯ç®¡ç†å™¨
        </h1>
        <p style="color:#888">æ’°å†™ã€ç»„è£…ã€ç®¡ç†æ‚¨çš„ AI æç¤ºè¯èµ„äº§</p>
    </header>

    <div class="main-container">
        
        <div>
            <div class="section-title">
                <span>ğŸ¨ æç¤ºè¯æ’°å†™åŠ©æ‰‹</span>
            </div>
            
            <div class="builder-area">
                <div class="meta-row">
                    <span style="font-size:14px; font-weight:bold; color:#666;">æ–‡ä»¶å:</span>
                    <input type="text" id="filenameInput" class="filename-input" placeholder="ä¾‹å¦‚: æ¦‚å¿µæ‹†è§£_v3.2.md">
                </div>

                <textarea id="promptInput" placeholder="# åœ¨æ­¤è¾“å…¥æç¤ºè¯å†…å®¹...&#10;- æ”¯æŒ Markdown æ ¼å¼&#10;- ç‚¹å‡»ä¸‹æ–¹æ ‡ç­¾å¯å¿«é€Ÿæ’å…¥"></textarea>

                <div class="builder-actions">
                    <div class="left-actions">
                        <button class="btn btn-secondary" onclick="document.getElementById('promptInput').value=''">ğŸ—‘ï¸ æ¸…ç©º</button>
                        <button class="btn btn-secondary" onclick="downloadLocal()">ğŸ’¾ å­˜åˆ°æœ¬åœ°</button>
                        <button class="btn btn-preview" onclick="openPreview()">ğŸ‘ï¸ é¢„è§ˆ</button>
                    </div>
                    <div class="right-actions">
                        <button class="btn btn-primary" onclick="copyPrompt()">ğŸ“‹ å¤åˆ¶</button>
                        <button id="btnPublish" class="btn btn-admin" onclick="pushToGitHub()" disabled title="éœ€ç®¡ç†å‘˜æƒé™">
                            ğŸ”’ éœ€æƒé™
                        </button>
                    </div>
                </div>

                <div class="library-area">
                    <div class="category-group">
                        <h3>å¸¸ç”¨æ ‡ç­¾</h3>
                        <div class="tags-container">
                            <div class="tag" onclick="addTag('Cyberpunk')">èµ›åšæœ‹å…‹</div>
                            <div class="tag" onclick="addTag('8k resolution')">8K åˆ†è¾¨ç‡</div>
                            <div class="tag" onclick="addTag('--ar 16:9')">å®½å± 16:9</div>
                            <div class="tag" onclick="addTag('--v 6.0')">MJ V6</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div>
            <div class="section-title">
                ğŸ“š æç¤ºè¯çŸ¥è¯†åº“ (è‡ªåŠ¨åŒæ­¥)
                <button class="refresh-btn" onclick="fetchRepoData()">ğŸ”„ åˆ·æ–°</button>
            </div>
            <div class="list-container">
                <div id="loadingState" style="padding:40px; text-align:center; color:#999;">æ­£åœ¨åŠ è½½...</div>
                <table id="dataTable" style="display:none;">
                    <thead>
                        <tr>
                            <th style="width: 25%;">æ–‡ä»¶å</th>
                            <th style="width: 10%;">ç‰ˆæœ¬</th>
                            <th style="width: 50%;">æ™ºèƒ½æè¿°</th>
                            <th style="width: 15%;">ä½œè€…</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
        </div>

    </div>

    <div class="modal-overlay" id="modalOverlay" onclick="if(event.target===this) closeModal()">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="modalTitle">é¢„è§ˆ</div>
                <button class="close-btn" onclick="closeModal()">Ã—</button>
            </div>
            <div class="modal-body" id="modalBody"></div>
            <div class="modal-footer" style="padding:15px; border-top:1px solid #eee; text-align:right;">
                <button class="btn btn-primary" id="modalCopyBtn" onclick="copyModalContent()">ğŸ“‹ å¤åˆ¶</button>
            </div>
        </div>
    </div>

    <script>
        // === é€»è¾‘éƒ¨åˆ† ===
        const promptInput = document.getElementById('promptInput');
        const filenameInput = document.getElementById('filenameInput');
        const btnPublish = document.getElementById('btnPublish');
        const tableBody = document.getElementById('tableBody');
        const loadingState = document.getElementById('loadingState');
        const dataTable = document.getElementById('dataTable');

        // ç›‘å¬ layout.js å‘å‡ºçš„è®¤è¯äº‹ä»¶ï¼Œè‡ªåŠ¨åˆ·æ–°æŒ‰é’®çŠ¶æ€
        window.addEventListener('auth-updated', checkAdminStatus);

        function addTag(text) {
            let current = promptInput.value;
            if (current.length > 0 && !current.endsWith(' ')) current += ' ';
            promptInput.value = current + text;
        }
        
        function copyPrompt() { navigator.clipboard.writeText(promptInput.value).then(() => alert('å·²å¤åˆ¶!')); }

        function openPreview() {
            const text = promptInput.value;
            if(!text.trim()) return;
            document.getElementById('modalTitle').innerText = "é¢„è§ˆ";
            document.getElementById('modalBody').innerHTML = `<div class="markdown-body">${marked.parse(text)}</div>`;
            document.getElementById('modalOverlay').classList.add('active');
        }

        function closeModal() { document.getElementById('modalOverlay').classList.remove('active'); }

        function downloadLocal() {
            const content = promptInput.value;
            let filename = filenameInput.value || "prompt.md";
            const blob = new Blob([content], { type: "text/markdown" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = filename;
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
        }

        // === æƒé™æ£€æŸ¥ ===
        function checkAdminStatus() {
            const token = localStorage.getItem('gh_token');
            if (token) {
                btnPublish.disabled = false;
                btnPublish.classList.add('active');
                btnPublish.innerHTML = "â˜ï¸ ä¿å­˜å¹¶å‘å¸ƒ";
                btnPublish.title = "ç‚¹å‡»å‘å¸ƒåˆ° GitHub";
            } else {
                btnPublish.disabled = true;
                btnPublish.classList.remove('active');
                btnPublish.innerHTML = "ğŸ”’ éœ€æƒé™";
                btnPublish.title = "è¯·åœ¨é¡µè„šé…ç½® GitHub Token";
            }
        }

        // === å‘å¸ƒåˆ° GitHub ===
        async function pushToGitHub() {
            const owner = localStorage.getItem('gh_owner');
            const repo = localStorage.getItem('gh_repo');
            const token = localStorage.getItem('gh_token');
            const content = promptInput.value;
            let filename = filenameInput.value || "untitled.md";
            
            if(!content.trim()) { alert("å†…å®¹ä¸ºç©º"); return; }
            
            btnPublish.innerHTML = "â³ å‘å¸ƒä¸­..."; btnPublish.disabled = true;
            
            try {
                const url = `https://api.github.com/repos/${owner}/${repo}/contents/prompt/${filename}`;
                
                // 1. æ£€æŸ¥æ˜¯å¦å­˜åœ¨
                let sha = null;
                const checkRes = await fetch(url, { headers: { 'Authorization': `token ${token}` } });
                if(checkRes.ok) {
                    const data = await checkRes.json();
                    sha = data.sha;
                    if(!confirm("æ–‡ä»¶å·²å­˜åœ¨ï¼Œæ˜¯å¦è¦†ç›–ï¼Ÿ")) throw new Error("å–æ¶ˆ");
                }

                // 2. ä¸Šä¼ 
                const payload = {
                    message: `Update ${filename}`,
                    content: btoa(unescape(encodeURIComponent(content))),
                    branch: "main",
                    sha: sha
                };
                
                const putRes = await fetch(url, {
                    method: 'PUT',
                    headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if(putRes.ok) {
                    alert("âœ… å‘å¸ƒæˆåŠŸï¼");
                    fetchRepoData(); // åˆ·æ–°åˆ—è¡¨
                } else {
                    throw new Error((await putRes.json()).message);
                }
            } catch(e) {
                if(e.message !== "å–æ¶ˆ") alert("å‘å¸ƒå¤±è´¥: " + e.message);
            } finally {
                checkAdminStatus(); // æ¢å¤æŒ‰é’®
            }
        }

        // === åˆ—è¡¨è¯»å– ===
        async function fetchRepoData() {
            loadingState.style.display = 'block'; dataTable.style.display = 'none'; tableBody.innerHTML = '';
            
            const owner = localStorage.getItem('gh_owner') || 'itskys';
            const repo = localStorage.getItem('gh_repo') || 'kayler';
            const token = localStorage.getItem('gh_token');
            const headers = token ? { 'Authorization': `token ${token}` } : {};

            try {
                const url = `https://api.github.com/repos/${owner}/${repo}/contents/prompt?ref=main&t=${Date.now()}`;
                const res = await fetch(url, { headers });
                if(!res.ok) throw new Error(res.status);
                
                const files = await res.json();
                const validFiles = files.filter(f => f.name.endsWith('.md'));
                
                validFiles.sort((a, b) => b.name.localeCompare(a.name));
                validFiles.forEach(f => renderRow(f, parseFilename(f.name)));
                
                loadingState.style.display = 'none'; dataTable.style.display = 'table';
            } catch(e) {
                loadingState.innerHTML = `âš ï¸ åŠ è½½å¤±è´¥ (${e.message})`;
            }
        }

        function parseFilename(name) {
            const clean = name.replace('.md', '');
            const parts = clean.split('_');
            return {
                name: parts[0] || clean,
                version: parts[1] || 'v1.0',
                desc: parts[2] || 'AI æç¤ºè¯æ–‡ä»¶',
                author: 'Kaylerris'
            };
        }

        function renderRow(file, meta) {
            let badgeClass = meta.version.includes('v3') ? 'badge v-new' : 'badge';
            const html = `
                <tr>
                    <td><a class="prompt-link" onclick="viewFile('${file.name}', '${meta.name}')">ğŸ“„ ${file.name}</a></td>
                    <td><span class="${badgeClass}">${meta.version}</span></td>
                    <td>${meta.desc}</td>
                    <td>${meta.author}</td>
                </tr>`;
            tableBody.insertAdjacentHTML('beforeend', html);
        }

        // === æŸ¥çœ‹é€»è¾‘ (æ··åˆæ¨¡å¼) ===
        let currentRawContent = '';
        function viewFile(fileName, title) {
            document.getElementById('modalTitle').innerText = title;
            document.getElementById('modalBody').innerHTML = `<pre class="raw-code" id="rawCode">â³ è¯»å–ä¸­...</pre>`;
            document.getElementById('modalOverlay').classList.add('active');

            // ä¼˜å…ˆè¯» Raw (å¿«)
            const owner = localStorage.getItem('gh_owner') || 'itskys';
            const repo = localStorage.getItem('gh_repo') || 'kayler';
            const url = `https://raw.githubusercontent.com/${owner}/${repo}/main/prompt/${fileName}`;
            
            fetch(url).then(r=>r.text()).then(t => {
                document.getElementById('rawCode').innerText = t;
                currentRawContent = t;
            }).catch(() => {
                // é™çº§è¯»æœ¬åœ°
                fetch('prompt/'+fileName).then(r=>r.text()).then(t=>{
                    document.getElementById('rawCode').innerText = t;
                    currentRawContent = t;
                });
            });
        }
        
        function copyModalContent() { navigator.clipboard.writeText(currentRawContent).then(()=>alert('å·²å¤åˆ¶')); }

        // å¯åŠ¨
        checkAdminStatus();
        fetchRepoData();

    </script>

</body>
</html>