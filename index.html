<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="description" content="Kayleræ–‡å­—å¡ç‰‡ç”Ÿæˆå™¨ - æ™ºèƒ½åˆ†é¡µã€é•¿å›¾æ§åˆ¶ã€‚">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kayleræ–‡å­—å¡ç‰‡ç”Ÿæˆå™¨ v3.4</title>
    <link rel="icon" href="/favicon.png" type="image/png">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="layout.js?v=6.0"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Ma+Shan+Zheng&family=Noto+Serif+SC:wght@400;700&family=ZCOOL+XiaoWei&display=swap" rel="stylesheet">
    
    <style>
        /* === å…¨å±€å˜é‡ === */
        :root {
            --bg-body: #f2f4f7; 
            --paper-bg: #fdfbf7; 
            --paper-texture: radial-gradient(#e6e2d8 1px, transparent 1px);
            --text-color: #2c2c2c;
            --title-color: #000;
            --shadow-color: rgba(0,0,0,0.08);
            --footer-color: #999;
            --brand-brown: #8b5e3c;
            --brand-brown-hover: #6d4c41;
            --base-font-size: 18px; 
            --font-heiti: "PingFang SC", "Microsoft YaHei", sans-serif;
            --font-songti: "Songti SC", "SimSun", serif;
            --font-noto-serif: "Noto Serif SC", serif;
            --font-kaiti: "KaiTi", "STKaiti", serif;
            --font-handwriting: "Ma Shan Zheng", cursive; 
            --font-xiaowei: "ZCOOL XiaoWei", serif;
        }

        /* === ä¸»é¢˜é…ç½® === */
        [data-theme="default"] { --paper-bg: #f9f7f1; --text-color: #2c2c2c; --paper-texture: radial-gradient(#e6e2d8 1px, transparent 1px); }
        [data-theme="white"] { --paper-bg: #ffffff; --text-color: #333333; --paper-texture: none; }
        [data-theme="green"] { --paper-bg: #f0f9eb; --text-color: #2b402b; --paper-texture: none; }
        [data-theme="blue"] { --paper-bg: #f0f4f8; --text-color: #2c3e50; --paper-texture: none; }
        [data-theme="kraft"] { --paper-bg: #e8dcc5; --text-color: #3e2b1d; --paper-texture: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0IiBoZWlnaHQ9IjQiPgo8cmVjdCB3aWR0aD0iNCIgaGVpZ2h0PSI0IiBmaWxsPSIjRThEQ0M1Ii8+CjxyZWN0IHdpZHRoPSIxIiBoZWlnaHQ9IjEiIGZpbGw9IixDOUNDOEYiIG9wYWNpdHk9IjAuMiIvPgo8L3N2Zz4='); }
        [data-theme="dark"] { --paper-bg: #1a1a1a; --text-color: #e0e0e0; --paper-texture: none; --shadow-color: rgba(0,0,0,0.5); --title-color: #fff; }
        [data-theme="pink"] { --paper-bg: #fff0f5; --text-color: #5c3a45; --paper-texture: none; }
        [data-theme="grey"] { --paper-bg: #f5f5f5; --text-color: #333; --paper-texture: none; }
        [data-theme="mint"] { --paper-bg: #e0f2f1; --text-color: #004d40; --paper-texture: none; }
        [data-theme="deepblue"] { --paper-bg: #263238; --text-color: #eceff1; --title-color: #fff; --paper-texture: none; --shadow-color: rgba(0,0,0,0.5); }

        body {
            font-family: var(--font-heiti);
            background-color: var(--bg-body);
            margin: 0; padding: 20px;
            display: flex; flex-direction: column; align-items: center;
            min-height: 100vh; color: #333;
        }

        header { text-align: center; width: 100%; max-width: 800px; margin-bottom: 20px; margin-top: 10px; }
        h1 { 
            font-size: 32px; margin: 0 0 8px 0; font-weight: 800; letter-spacing: -1px; color: #222; 
            display: flex; align-items: center; justify-content: center;
        }
        
        .global-counter {
            font-size: 14px; color: #888; font-family: "PingFang SC", sans-serif;
            font-weight: 500; letter-spacing: 0.5px;
        }

        /* === å¸ƒå±€å®¹å™¨ä¼˜åŒ– === */
        
        /* 1. å·¥å…·æ  (Themes/Fonts) */
        .toolbar-wrapper {
            background: white; padding: 15px 25px; border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.03);
            margin-bottom: 12px;
            display: flex; flex-direction: column; gap: 12px;
            width: 100%; max-width: 1200px; box-sizing: border-box;
        }

        /* 2. Emoji æ ç‹¬ç«‹å®¹å™¨ - å…¨å®½æ˜¾ç¤º */
        .emoji-wrapper {
            background: white; padding: 10px 20px; border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.03);
            margin-bottom: 12px;
            width: 100%; max-width: 1200px; box-sizing: border-box;
            display: flex; flex-wrap: wrap; align-items: center;
        }

        .emoji-bar {
            display: flex; gap: 8px; 
            flex-wrap: wrap; /* å…è®¸æ¢è¡Œ */
            align-items: center; 
            width: 100%;
        }
        .emoji-item {
            font-size: 20px; cursor: pointer; padding: 5px;
            border-radius: 6px; transition: background 0.2s; user-select: none;
        }
        .emoji-item:hover { background: rgba(0,0,0,0.05); transform: scale(1.1); }

        /* 3. ä¸»åŒæ ç»“æ„ */
        .container {
            display: flex; 
            gap: 12px; /* 3mm é—´è· */
            width: 100%; max-width: 1200px; 
            flex-wrap: wrap; justify-content: center; align-items: flex-start;
        }

        /* å·¦ä¾§è¾“å…¥åŒº */
        .input-area { 
            flex: 1; min-width: 320px; 
            display: flex; flex-direction: column; 
        }

        /* å³ä¾§é¢„è§ˆåŒº */
        .preview-area { 
            flex: 1; min-width: 350px; 
            display: flex; flex-direction: column; 
            align-items: flex-end; /* å¼ºåˆ¶å³å¯¹é½ */
        }

        /* å·¥å…·æ é€šç”¨æ ·å¼ */
        .tool-row { display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 15px; }
        .tool-group { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
        .tool-label { font-size: 13px; color: #999; font-weight: 600; display: flex; align-items: center; gap: 4px; white-space: nowrap; }
        .tool-divider { width: 100%; height: 1px; background: #f0f0f0; margin: 2px 0; }
        
        .theme-btn { width: 24px; height: 24px; border-radius: 50%; border: 2px solid #f0f0f0; cursor: pointer; transition: all 0.2s; position: relative; }
        .theme-btn:hover { transform: scale(1.1); border-color: #ddd; }
        .theme-btn.active { border-color: var(--brand-brown); transform: scale(1.2); box-shadow: 0 2px 6px rgba(0,0,0,0.2); z-index: 2; }
        
        .bg-default { background: #f9f7f1; } .bg-white { background: #ffffff; border:1px solid #eee; }
        .bg-green { background: #f0f9eb; } .bg-blue { background: #f0f4f8; }
        .bg-kraft { background: #e8dcc5; } .bg-dark { background: #1a1a1a; }
        .bg-pink { background: #fff0f5; } .bg-grey { background: #f5f5f5; }
        .bg-mint { background: #e0f2f1; } .bg-deepblue { background: #263238; }

        .select-ui, .input-ui { padding: 6px 10px; border-radius: 6px; background: #f9f9f9; border: 1px solid #eee; font-size: 13px; color: #555; outline: none; transition: all 0.2s; }
        .select-ui:hover, .input-ui:hover { background: #fff; border-color: #ddd; }
        .select-ui:focus, .input-ui:focus { border-color: var(--brand-brown); background: #fff; }

        .upload-btn { font-size: 13px; padding: 6px 12px; border-radius: 6px; border: 1px dashed #ccc; background: #fff; color: #666; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 5px; }
        .upload-btn:hover { border-color: var(--brand-brown); color: var(--brand-brown); background: #fafafa; }
        
        .slider-container { display: flex; align-items: center; gap: 8px; font-size: 12px; color: #888; }
        input[type=range] { width: 80px; cursor: pointer; height: 4px; border-radius: 2px; accent-color: var(--brand-brown); }

        .textarea-wrapper { position: relative; width: 100%; }
        
        textarea {
            width: 100%; padding: 25px; padding-bottom: 40px;
            border: none; border-radius: 12px;
            font-size: 16px; line-height: 1.6;
            box-shadow: 0 4px 20px rgba(0,0,0,0.03);
            resize: none; overflow-y: hidden; outline: none;
            min-height: 500px; font-family: inherit; background: #fff;
            transition: box-shadow 0.3s; box-sizing: border-box;
        }
        textarea:focus { box-shadow: 0 8px 30px rgba(0,0,0,0.08); }

        .word-count { position: absolute; bottom: 15px; right: 20px; font-size: 12px; color: #bbb; pointer-events: none; }

        .action-buttons { display: flex; gap: 12px; flex-wrap: wrap; margin-top: 15px; }
        
        .btn-base { flex: 1; padding: 12px; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; display: flex; justify-content: center; align-items: center; gap: 6px; min-width: 100px; }
        .btn-base:active { transform: scale(0.98); }

        .btn-download { background-color: var(--brand-brown); color: #fff; box-shadow: 0 4px 15px rgba(139, 94, 60, 0.2); }
        .btn-download:hover { background-color: var(--brand-brown-hover); box-shadow: 0 6px 20px rgba(139, 94, 60, 0.3); }
        .btn-copy { background-color: #e3f2fd; color: #1565c0; }
        .btn-copy:hover { background-color: #bbdefb; }
        .btn-publish { background: linear-gradient(135deg, #667eea, #764ba2); color: white; display: none; }
        .btn-publish:hover { opacity: 0.9; box-shadow: 0 4px 12px rgba(118, 75, 162, 0.3); }

        .hint-text { font-size: 12px; color: #aaa; text-align: center; margin-top: 10px; }

        .card-container {
            width: 100%; 
            max-width: 680px; 
            display: flex; flex-direction: column; gap: 10px;
        }

        .paper-card {
            width: 100%; 
            background-color: var(--paper-bg);
            background-image: var(--paper-texture);
            background-size: 20px 20px;
            padding: 60px 45px;
            box-shadow: 20px 20px 60px var(--shadow-color);
            border-radius: 6px;
            color: var(--text-color);
            transition: all 0.3s ease;
            position: relative; 
            overflow: hidden; 
            box-sizing: border-box;
        }

        .card-bg-layer { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-position: top center; background-repeat: repeat-y; background-size: 100% auto; z-index: 0; pointer-events: none; }

        .card-toolbar { display: flex; justify-content: flex-end; gap: 10px; padding: 0 5px; opacity: 0.8; }
        .mini-btn { font-size: 12px; padding: 5px 10px; border-radius: 6px; border: none; background: rgba(0,0,0,0.05); color: #666; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 4px; }
        .mini-btn:hover { background: #e3f2fd; color: #1565c0; }

        .paper-content, .paper-footer, .paper-title, .paper-subtitle, .page-indicator { position: relative; z-index: 1; }
        .paper-content { font-family: var(--active-font-family); font-size: var(--base-font-size); line-height: 1.75; text-align: justify; min-height: 200px; }
        .paper-title { font-family: var(--active-font-family); font-size: calc(var(--base-font-size) * 1.5); font-weight: bold; text-align: center; margin-bottom: 25px; color: var(--title-color); line-height: 1.3; }
        .paper-subtitle { font-family: var(--active-font-family); font-size: calc(var(--base-font-size) * 1.2); font-weight: bold; text-align: center; margin-top: -15px; margin-bottom: 30px; color: var(--title-color); opacity: 0.85; letter-spacing: 1px; }

        .paper-p { margin: 0; margin-top: 10pt; }
        .indent-cn { text-indent: 2em; }
        .indent-en { text-indent: 1.37cm; }

        .paper-footer { margin-top: 60px; text-align: right; font-size: 14px; color: var(--footer-color); border-top: 1px solid rgba(0,0,0,0.06); padding-top: 18px; font-family: -apple-system, BlinkMacSystemFont, sans-serif; }
        .paper-footer a { color: inherit; text-decoration: none; border-bottom: 1px dashed currentColor; font-weight: 600; }

        .page-indicator { position: absolute; top: -25px; left: 0; font-size: 12px; color: #ccc; font-weight: bold; }

        #loading-toast { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.8); color: white; padding: 15px 30px; border-radius: 8px; font-size: 16px; z-index: 99999; display: none; }

        @media (max-width: 768px) {
            .container { gap: 30px; flex-direction: column; }
            body { padding: 10px; }
            h1 { font-size: 24px; }
            .paper-card { padding: 30px 20px; }
            .toolbar-wrapper, .emoji-wrapper { padding: 15px; width: 100%; gap: 15px; }
            .tool-row { justify-content: flex-start; gap: 10px; }
            .tool-group { width: 100%; justify-content: space-between; }
            .tool-group:first-child { justify-content: flex-start; }
            .preview-area { align-items: center; width: 100%; }
            .card-container { width: 100%; max-width: 100%; }
        }
    </style>
</head>
<body>
    
    <div id="loading-toast">â˜ï¸ æ­£åœ¨å‘å¸ƒåˆ°ç”»å»Š...</div>

    <header>
        <h1>
            <img src="/logo.png" alt="Logo" style="height: 40px; vertical-align: middle; margin-right: 10px; margin-top: -6px;">
            Kayleræ–‡å­—å¡ç‰‡ç”Ÿæˆå™¨
        </h1>
        <div class="global-counter" id="counterDisplay">
            âœ¨ å·²ç´¯è®¡ååŠ©ç”Ÿæˆ <span id="totalCount">...</span> å¼ ç²¾è‡´å¡ç‰‡
        </div>
    </header>

    <div class="toolbar-wrapper">
        <div class="tool-row">
            <div class="tool-group">
                <span class="tool-label">ğŸ¨ ä¸»é¢˜:</span>
                <div class="theme-btn bg-default active" onclick="setTheme('default', this)" title="ç»å…¸ç¾Šçš®"></div>
                <div class="theme-btn bg-white" onclick="setTheme('white', this)" title="æç®€çº¯ç™½"></div>
                <div class="theme-btn bg-pink" onclick="setTheme('pink', this)" title="æ¨±èŠ±ç²‰"></div>
                <div class="theme-btn bg-green" onclick="setTheme('green', this)" title="æŠ¤çœ¼ç»¿"></div>
                <div class="theme-btn bg-mint" onclick="setTheme('mint', this)" title="è–„è·ç»¿"></div>
                <div class="theme-btn bg-blue" onclick="setTheme('blue', this)" title="é™è°§è“"></div>
                <div class="theme-btn bg-grey" onclick="setTheme('grey', this)" title="æç®€ç°"></div>
                <div class="theme-btn bg-kraft" onclick="setTheme('kraft', this)" title="å¤å¤ç‰›çš®"></div>
                <div class="theme-btn bg-deepblue" onclick="setTheme('deepblue', this)" title="æ·±æµ·è“"></div>
                <div class="theme-btn bg-dark" onclick="setTheme('dark', this)" title="æš—å¤œæå®¢"></div>
            </div>

            <div class="tool-group">
                <input type="file" id="bgInput" accept="image/*" style="display: none;" onchange="handleBgUpload(this)">
                <button id="uploadBtn" class="upload-btn" onclick="document.getElementById('bgInput').click()">
                    <span>ğŸ–¼ï¸ èƒŒæ™¯å›¾</span>
                </button>
                <div class="slider-container">
                    <span>é€æ˜åº¦:</span>
                    <input type="range" id="opacitySlider" min="0.05" max="0.8" step="0.05" value="0.15" oninput="updateOpacity(this.value)">
                    <span id="opacityValue">15%</span>
                </div>
            </div>
        </div>

        <div class="tool-divider"></div>

        <div class="tool-row">
            <div class="tool-group">
                <span class="tool-label">ğŸ…°ï¸ å­—ä½“:</span>
                <select class="select-ui" onchange="setFontFamily(this.value)">
                    <option value="heiti" selected>ç°ä»£é»‘ä½“</option>
                    <option value="songti">æ–‡è‰ºå®‹ä½“</option>
                    <option value="noto">æ€æºå®‹ä½“</option>
                    <option value="kaiti">æ¥·ä½“</option>
                    <option value="xiaowei">æ–‡è‰ºä½“</option>
                    <option value="handwriting">ä¼˜é›…æ‰‹å†™</option>
                </select>
            </div>
            
            <div class="tool-group">
                <span class="tool-label">ğŸ“ å­—å·:</span>
                <input type="range" min="14" max="24" value="18" oninput="setFontSize(this.value)" style="width:60px;">
                <span id="fontSizeDisplay" style="font-size:12px; color:#888;">18px</span>
            </div>

            <div class="tool-group">
                <span class="tool-label">âœï¸ ç­¾å:</span>
                <input type="text" class="input-ui" style="width:100px;" id="signatureInput" placeholder="Kaylerris" value="Kaylerris" oninput="updateSignature(this.value)">
            </div>

            <div class="tool-group">
                <span class="tool-label">ğŸ“„ åˆ†é¡µ:</span>
                <select id="splitMode" class="select-ui" onchange="renderCards()">
                    <option value="count" selected>ç­‰åˆ† X å¼ </option>
                    <option value="single">å•å¼ é•¿å›¾</option>
                    <option value="length">1kå­—/å¼ </option>
                </select>
                <input type="number" id="splitCount" class="input-ui" style="width:40px; padding:6px;" value="2" min="2" max="10" onchange="renderCards()">
            </div>
        </div>
    </div>

    <div class="emoji-wrapper">
        <div class="emoji-bar" id="emojiBar">
            <span class="emoji-item" onclick="insertEmoji('âœ¨')">âœ¨</span>
            <span class="emoji-item" onclick="insertEmoji('âœ’ï¸')">âœ’ï¸</span>
            <span class="emoji-item" onclick="insertEmoji('ğŸŒ¿')">ğŸŒ¿</span>
            <span class="emoji-item" onclick="insertEmoji('ğŸ’¡')">ğŸ’¡</span>
            <span class="emoji-item" onclick="insertEmoji('ğŸ“–')">ğŸ“–</span>
            <span class="emoji-item" onclick="insertEmoji('ğŸ’­')">ğŸ’­</span>
            <span class="emoji-item" onclick="insertEmoji('ğŸ“Œ')">ğŸ“Œ</span>
            <span class="emoji-item" onclick="insertEmoji('ğŸŒŸ')">ğŸŒŸ</span>
            <span class="emoji-item" onclick="insertEmoji('â¤ï¸')">â¤ï¸</span>
            <span class="emoji-item" onclick="insertEmoji('â˜•')">â˜•</span>
            <span class="emoji-item" onclick="insertEmoji('ğŸ¨')">ğŸ¨</span>
            <span class="emoji-item" onclick="insertEmoji('ğŸ¹')">ğŸ¹</span>
            <span class="emoji-item" onclick="insertEmoji('ğŸ»')">ğŸ»</span>
            <span class="emoji-item" onclick="insertEmoji('ğŸŒˆ')">ğŸŒˆ</span>
            <span class="emoji-item" onclick="insertEmoji('â˜€ï¸')">â˜€ï¸</span>
            <span class="emoji-item" onclick="insertEmoji('ğŸŒŠ')">ğŸŒŠ</span>
            <span class="emoji-item" onclick="insertEmoji('ğŸ‚')">ğŸ‚</span>
            <span class="emoji-item" onclick="insertEmoji('ğŸ')">ğŸ</span>
            <span class="emoji-item" onclick="insertEmoji('ğŸ„')">ğŸ„</span>
            <span class="emoji-item" onclick="insertEmoji('ğŸŒº')">ğŸŒº</span>
            <span class="emoji-item" onclick="insertEmoji('ğŸŒ¸')">ğŸŒ¸</span>
            <span class="emoji-item" onclick="insertEmoji('ğŸŒ¼')">ğŸŒ¼</span>
            <span class="emoji-item" onclick="insertEmoji('ğŸŒ»')">ğŸŒ»</span>
            <span class="emoji-item" onclick="insertEmoji('ğŸ€')">ğŸ€</span>
            <span class="emoji-item" onclick="insertEmoji('ğŸ°')">ğŸ°</span>
            <span class="emoji-item" onclick="insertEmoji('ğŸ—½')">ğŸ—½</span>
            <span class="emoji-item" onclick="insertEmoji('ğŸ—¼')">ğŸ—¼</span>
            <span class="emoji-item" onclick="insertEmoji('âœˆï¸')">âœˆï¸</span>
            <span class="emoji-item" onclick="insertEmoji('ğŸš€')">ğŸš€</span>
            <span class="emoji-item" onclick="insertEmoji('ğŸ›¸')">ğŸ›¸</span>
            <span class="emoji-item" onclick="insertEmoji('ğŸ¦')">ğŸ¦</span>
            <span class="emoji-item" onclick="insertEmoji('ğŸ°')">ğŸ°</span>
            <span class="emoji-item" onclick="insertEmoji('ğŸ·')">ğŸ·</span>
            <span class="emoji-item" onclick="insertEmoji('ğŸ¶')">ğŸ¶</span>
            <span class="emoji-item" onclick="insertEmoji('ğŸ“¢')">ğŸ“¢</span>
            <span class="emoji-item" onclick="insertEmoji('ğŸ””')">ğŸ””</span>
            <span class="emoji-item" onclick="insertEmoji('ğŸ“…')">ğŸ“…</span>
            <span class="emoji-item" onclick="insertEmoji('ğŸ“')">ğŸ“</span>
            <span class="emoji-item" onclick="insertEmoji('ğŸ“')">ğŸ“</span>
            <span class="emoji-item" onclick="insertEmoji('âœ…')">âœ…</span>
            <span class="emoji-item" onclick="insertEmoji('ğŸ’»')">ğŸ’»</span>
        </div>
    </div>

    <div class="container">
        <div class="input-area">
            <div class="textarea-wrapper">
                <textarea id="inputText" placeholder="åœ¨æ­¤ç²˜è´´æ–‡ç« ...&#10;&#10;è‡ªåŠ¨ä¿å­˜åŠŸèƒ½å·²å¯ç”¨ï¼Œä¸ç”¨æ‹…å¿ƒå†…å®¹ä¸¢å¤±ã€‚&#10;å¯ä»¥åœ¨ä¸Šæ–¹å·¥å…·æ ä¿®æ”¹ @ç½²åã€‚"></textarea>
                <div id="wordCount" class="word-count">0 å­—</div>
            </div>
            
            <div class="action-buttons">
                <button class="btn-base btn-download" onclick="generateBatch('download')">
                    <span>ğŸ’¾ æ‰¹é‡ä¸‹è½½</span>
                </button>
                <button id="btnCopy" class="btn-base btn-copy" onclick="generateBatch('copy')">
                    <span>ğŸ“‹ å¤åˆ¶ç¬¬ä¸€å¼ </span>
                </button>
                <button id="btnPublish" class="btn-base btn-publish" onclick="publishToGallery()">
                    â˜ï¸ å‘å¸ƒåˆ°ç”»å»Š
                </button>
            </div>
            
            <p class="hint-text">
                æç¤ºï¼šå³ä¾§æ¯å¼ å¡ç‰‡ä¸‹æ–¹å‡å¯å•ç‹¬å¤åˆ¶æˆ–ä¿å­˜
            </p>
        </div>

        <div class="preview-area" id="previewContainerWrapper">
            <div id="previewContainer" style="width:100%; display:flex; flex-direction:column; align-items:flex-end; gap:20px;">
                </div>
        </div>
    </div>

    <script>
        const inputText = document.getElementById('inputText');
        const previewContainer = document.getElementById('previewContainer');
        const wordCountEl = document.getElementById('wordCount');
        const counterDisplay = document.getElementById('totalCount');
        const opacityValueLabel = document.getElementById('opacityValue');
        const fontSizeDisplay = document.getElementById('fontSizeDisplay');
        const uploadBtn = document.getElementById('uploadBtn');
        const splitModeSelect = document.getElementById('splitMode');
        const splitCountInput = document.getElementById('splitCount');
        const btnPublish = document.getElementById('btnPublish');
        const toast = document.getElementById('loading-toast');

        let customBgUrl = null;
        let currentOpacity = 0.15; 
        let currentFont = 'heiti';
        let currentSignature = 'Kaylerris';

        const savedDraft = localStorage.getItem('kayler_draft');
        if (savedDraft) { inputText.value = savedDraft; }
        
        const BASE_COUNT = 12580; 
        async function updateCounter() {
            let userCount = parseInt(localStorage.getItem('kayler_usage_count') || '0');
            let githubCount = 0;
            try {
                const res = await fetch(`https://api.github.com/repos/itskys/kayler/contents/gallery`);
                if(res.ok) {
                    const files = await res.json();
                    githubCount = files.length * 10;
                }
            } catch(e) {}
            let total = BASE_COUNT + githubCount + userCount;
            counterDisplay.innerText = total.toLocaleString();
        }
        updateCounter();

        function checkAdmin() {
            if(localStorage.getItem('gh_token')) {
                btnPublish.style.display = 'flex';
            }
        }
        window.addEventListener('auth-updated', checkAdmin);
        checkAdmin();

        inputText.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.max(500, this.scrollHeight) + 'px'; 
            wordCountEl.innerText = `${this.value.length} å­—`;
            localStorage.setItem('kayler_draft', this.value);
            renderCards(); 
        });

        function setFontFamily(font) {
            currentFont = font;
            let val = '';
            if (font === 'songti') val = 'var(--font-songti)';
            else if (font === 'heiti') val = 'var(--font-heiti)';
            else if (font === 'noto') val = 'var(--font-noto-serif)';
            else if (font === 'kaiti') val = 'var(--font-kaiti)';
            else if (font === 'xiaowei') val = 'var(--font-xiaowei)';
            else if (font === 'handwriting') val = 'var(--font-handwriting)';
            document.documentElement.style.setProperty('--active-font-family', val);
        }
        setFontFamily('heiti');

        function setFontSize(val) {
            document.documentElement.style.setProperty('--base-font-size', val + 'px');
            fontSizeDisplay.innerText = val + 'px';
        }

        function updateSignature(val) {
            currentSignature = val;
            document.querySelectorAll('.signature-display').forEach(el => el.innerText = '@' + val);
        }

        function setTheme(themeName, btnElement) {
            document.documentElement.setAttribute('data-theme', themeName);
            document.querySelectorAll('.theme-btn').forEach(btn => btn.classList.remove('active'));
            btnElement.classList.add('active');
        }

        function updateOpacity(val) {
            currentOpacity = val;
            opacityValueLabel.innerText = Math.round(val * 100) + '%';
            document.querySelectorAll('.card-bg-layer').forEach(layer => layer.style.opacity = currentOpacity);
        }

        function insertEmoji(emoji) {
            const start = inputText.selectionStart;
            const end = inputText.selectionEnd;
            const text = inputText.value;
            inputText.value = text.substring(0, start) + emoji + text.substring(end);
            inputText.focus();
            inputText.dispatchEvent(new Event('input'));
        }

        function renderCards() {
            const rawText = inputText.value;
            if (!rawText.trim()) return;

            const lines = rawText.split('\n');
            let mainTitle = lines.length > 0 ? lines[0].trim() : "æ— æ ‡é¢˜";
            let paragraphs = [];
            for (let i = 1; i < lines.length; i++) {
                if (lines[i].trim()) paragraphs.push(lines[i]);
            }

            const mode = splitModeSelect.value;
            const splitCount = parseInt(document.getElementById('splitCount').value) || 2;
            const totalChars = paragraphs.join('').length;
            let charsPerPageTarget = 1000;

            if (mode === 'count') {
                document.getElementById('splitCount').style.display = 'inline-block';
                charsPerPageTarget = Math.max(100, Math.ceil(totalChars / splitCount));
            } else {
                document.getElementById('splitCount').style.display = 'none';
                if (mode === 'single') charsPerPageTarget = 9999999;
                else if (mode === 'length') charsPerPageTarget = 1000;
            }

            let pages = [];
            let currentPageContent = [];
            let currentLength = 0;

            paragraphs.forEach((p, index) => {
                currentPageContent.push(p);
                currentLength += p.length;
                if (currentLength >= charsPerPageTarget && index < paragraphs.length - 1) {
                    pages.push(currentPageContent);
                    currentPageContent = [];
                    currentLength = 0;
                }
            });
            if (currentPageContent.length > 0) pages.push(currentPageContent);
            if (pages.length === 0) pages.push([]);

            let html = '';
            pages.forEach((pageParas, index) => {
                let cardContent = "";
                if (index === 0) {
                    cardContent += `<div class="paper-title">${escapeHtml(mainTitle)}</div>`;
                } else {
                    const suffix = index + 1; 
                    cardContent += `<div class="paper-title" style="margin-bottom:15px">${escapeHtml(mainTitle)}</div>`;
                    cardContent += `<div class="paper-subtitle">ï¼ˆç»­${suffix}ï¼‰</div>`;
                }
                
                pageParas.forEach(p => {
                    const indentClass = /[\u4e00-\u9fa5]/.test(p) ? 'indent-cn' : 'indent-en';
                    cardContent += `<div class="paper-p ${indentClass}">${escapeHtml(p)}</div>`;
                });

                let pageIndicator = pages.length > 1 ? `<div class="page-indicator">ç¬¬ ${index+1} / ${pages.length} é¡µ</div>` : '';
                let bgStyle = customBgUrl ? `background-image: url('${customBgUrl}'); opacity: ${currentOpacity};` : `opacity: 0;`;

                html += `
                <div class="card-container">
                    <div class="paper-card" id="card-${index}">
                        ${pageIndicator}
                        <div class="card-bg-layer" style="${bgStyle}"></div>
                        <div class="paper-content">${cardContent}</div>
                        <div class="paper-footer">
                            Created by <span class="signature-display">@${escapeHtml(currentSignature)}</span> with <a href="https://x.aisai.cc/" target="_blank">x.aisai.cc</a>
                        </div>
                    </div>
                    <div class="card-toolbar">
                        <button class="mini-btn" onclick="downloadSingle(${index})">ğŸ’¾ ä¿å­˜</button>
                        <button class="mini-btn" onclick="copySingle(${index}, this)">ğŸ“‹ å¤åˆ¶</button>
                    </div>
                </div>`;
            });
            previewContainer.innerHTML = html;
        }

        async function publishToGallery() {
            const token = localStorage.getItem('gh_token');
            const owner = localStorage.getItem('gh_owner');
            const repo = localStorage.getItem('gh_repo');
            
            if(!token) { alert("Token ä¸¢å¤±ï¼Œè¯·é‡æ–°ç™»å½•"); return; }
            if(!inputText.value.trim()) { alert("å†…å®¹ä¸ºç©ºï¼Œæ— æ³•ç”Ÿæˆ"); return; }

            const confirmUpload = confirm("ç¡®å®šè¦å°†ç¬¬ä¸€å¼ å¡ç‰‡å‘å¸ƒåˆ°ã€ŒAI å›¾ç‰‡å±•ã€å—ï¼Ÿ");
            if(!confirmUpload) return;

            toast.style.display = 'block';
            
            try {
                const card = document.getElementById('card-0');
                const canvas = await html2canvas(card, { scale: 2, useCORS: true, backgroundColor: null });
                const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
                
                const reader = new FileReader();
                reader.readAsDataURL(blob);
                reader.onloadend = async () => {
                    const base64Content = reader.result.split(',')[1];
                    const titleLine = inputText.value.split('\n')[0].trim().substring(0, 10).replace(/[\\/:*?"<>|]/g, "");
                    const dateStr = new Date().toISOString().slice(0,10).replace(/-/g,"");
                    const filename = `${dateStr}_${titleLine}.png`;
                    const path = `gallery/${filename}`;

                    const url = `https://api.github.com/repos/${owner}/${repo}/contents/${path}`;
                    const res = await fetch(url, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `token ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            message: `Upload gallery: ${filename}`,
                            content: base64Content,
                            branch: 'main'
                        })
                    });

                    if(res.ok) {
                        alert("âœ… å‘å¸ƒæˆåŠŸï¼\nå›¾ç‰‡å·²ä¸Šä¼ è‡³ç”»å»Šï¼Œç¨åå³å¯åœ¨ AI å›¾ç‰‡å±•ä¸­çœ‹åˆ°ã€‚");
                    } else {
                        const err = await res.json();
                        throw new Error(err.message);
                    }
                    toast.style.display = 'none';
                };
            } catch(e) {
                console.error(e);
                alert("å‘å¸ƒå¤±è´¥: " + e.message);
                toast.style.display = 'none';
            }
        }

        function escapeHtml(text) { return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;"); }
        
        function handleBgUpload(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    customBgUrl = e.target.result;
                    renderCards();
                    uploadBtn.querySelector('span').innerText = "âœ… å·²è®¾ç½®";
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function downloadSingle(index) {
            const card = document.getElementById(`card-${index}`);
            html2canvas(card, { scale: 2, useCORS: true, backgroundColor: null }).then(canvas => {
                const link = document.createElement('a');
                link.download = `card_${index+1}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
            });
        }
        function copySingle(index, btn) {
            const card = document.getElementById(`card-${index}`);
            const originalText = btn.innerText;
            btn.innerText = "â³";
            html2canvas(card, { scale: 2, useCORS: true, backgroundColor: null }).then(canvas => {
                canvas.toBlob(blob => {
                    navigator.clipboard.write([new ClipboardItem({ "image/png": blob })]).then(() => {
                        btn.innerText = "âœ… å·²å¤åˆ¶";
                        setTimeout(() => btn.innerText = originalText, 2000);
                    });
                });
            });
        }
        async function generateBatch(action) {
            const cards = document.querySelectorAll('.paper-card');
            if(action === 'copy') { copySingle(0, document.getElementById('btnCopy')); return; }
            for(let i=0; i<cards.length; i++) {
                downloadSingle(i);
                await new Promise(r => setTimeout(r, 500));
            }
        }

        if(inputText.value.trim() === "") inputText.value = "æ¬¢è¿ä½¿ç”¨ Kayler æ–‡å­—å¡ç‰‡ç”Ÿæˆå™¨ï¼...";
        inputText.dispatchEvent(new Event('input'));
    </script>
</body>
</html>